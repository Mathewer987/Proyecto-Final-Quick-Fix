<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitudes de Trabajo - QuickFix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='Home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='AceptarTrabajosStyle.css') }}">
    <style>
        /* Solo mantener estilos cr√≠ticos inline, el resto mover a CSS externo */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
        <div class="line line-4"></div>
    </div>
    
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">Quick<span>Fix</span></div>
                <a href="{{ url_for('home') }}" class="back-button"><i class="fas fa-arrow-left"></i> Volver</a>
            </div>
            <nav class="nav">
                <a href="{{ url_for('home') }}" class="nav-item">Inicio</a>
                <a href="/trabajos" class="nav-item active">Solicitudes</a>
                <a href="#" class="nav-item">Mis Servicios</a>
                <a href="#" class="nav-item">Ayuda</a>
                <a class="nav-item" href="{{ url_for('logout') }}"><i class="fas fa-user"></i> Cerrar Sesi√≥n</a>
            </nav>
        </header>
        
        <main class="results-container">
            <div class="results-header">
                <h2>Solicitudes Pendientes</h2>
                <div class="results-count">
                    <span class="count-badge contratacion">{{ trabajos_contrataciones|length }} contrataciones</span>
                    <span class="count-badge mentoria">{{ trabajos_mentorias|length }} mentor√≠as</span>
                </div>
            </div>

            <!-- SECCI√ìN CONTRATACIONES DE CLIENTES -->
            <div class="seccion-solicitudes">
                <div class="seccion-header">
                    <h3>Contrataciones de Clientes</h3>
                    <span class="contador-solicitudes">{{ trabajos_contrataciones|length }} pendientes</span>
                </div>
                
                {% if trabajos_contrataciones %}
                <div class="jobs-list">
                    {% for trabajo in trabajos_contrataciones %}
                    <div class="job-card {% if trabajo.urgente %}highlighted{% endif %}" data-tipo="contratacion" data-id="{{ trabajo.id }}">
                        
                        {% if trabajo.urgente %}
                        <div class="job-badge">Urgente</div>
                        {% endif %}
                        
                        <div class="job-content">
                            <h3>Solicitud de {{ trabajo.especializacion }}</h3>
                            <div class="job-description">
                                <p><strong>Cliente:</strong> {{ trabajo.cliente_nombre }}</p>
                                <p><strong>Especificaciones:</strong> {{ trabajo.especificaciones }}</p>
                            </div>
                            <div class="job-details">
                                <div class="detail">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>{{ trabajo.ubicacion }}</span>
                                </div>
                                <div class="detail">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Fecha solicitada: {{ trabajo.fecha_trabajo_propuesta }}</span>
                                </div>
                                <div class="detail">
                                    <i class="fas fa-credit-card"></i>
                                    <span>M√©todo de pago: {{ trabajo.metodo_pago }}</span>
                                </div>
                                <div class="detail">
                                    <i class="fas fa-clock"></i>
                                    <span>Solicitado el: {{ trabajo.fecha_solicitud.strftime('%d/%m/%Y') }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="job-actions">
                            <button class="action-button view-details" data-action="ver-detalles">Ver detalles</button>
                            <button class="action-button apply-now" data-action="aceptar">Aceptar</button>
                            <button class="action-button reject" data-action="rechazar">Rechazar</button>
                            <button class="action-button return" data-action="devolver">Devolver</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-solicitudes">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No tienes contrataciones pendientes</h3>
                    <p>Cuando recibas nuevas solicitudes de trabajo, aparecer√°n aqu√≠.</p>
                </div>
                {% endif %}
            </div>

            <!-- SECCI√ìN SOLICITUDES DE MENTOR√çA -->
            <div class="seccion-solicitudes">
                <div class="seccion-header">
                    <h3>Solicitudes de Mentor√≠a</h3>
                    <span class="contador-solicitudes">{{ trabajos_mentorias|length }} pendientes</span>
                </div>
                
                {% if trabajos_mentorias %}
                <div class="jobs-list">
                    {% for mentoria in trabajos_mentorias %}
                    <div class="job-card" data-tipo="mentoria" data-id="{{ mentoria.id }}">
                        <div class="job-content">
                            <h3>Solicitud de Mentor√≠a - {{ mentoria.area_interes }}</h3>
                            <div class="job-description">
                                <p><strong>Aprendiz:</strong> {{ mentoria.desempleado_nombre }}</p>
                                <p><strong>Objetivos:</strong> {{ mentoria.objetivo[:100] }}{% if mentoria.objetivo|length > 100 %}...{% endif %}</p>
                            </div>
                            <div class="job-details">
                                <div class="detail">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>√Årea: {{ mentoria.area_interes }}</span>
                                </div>
                                <div class="detail">
                                    <i class="fas fa-clock"></i>
                                    <span>Disponibilidad: {{ mentoria.disponibilidad }}</span>
                                </div>
                                <div class="detail">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Solicitado el: {{ mentoria.fecha_solicitud.strftime('%d/%m/%Y') }}</span>
                                </div>
                                <div class="detail">
                                    <i class="fas fa-user-graduate"></i>
                                    <span>Tipo: Solicitud de mentor√≠a</span>
                                </div>
                            </div>
                        </div>
                        <div class="job-actions">
                            <button class="action-button view-details" data-action="ver-detalles-mentoria">Ver detalles</button>
                            <button class="action-button apply-now" data-action="aceptar-mentoria">Aceptar Mentor√≠a</button>
                            <button class="action-button reject" data-action="rechazar-mentoria">Rechazar</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-solicitudes">
                    <i class="fas fa-users"></i>
                    <h3>No tienes solicitudes de mentor√≠a</h3>
                    <p>Cuando recibas solicitudes de mentor√≠a, aparecer√°n aqu√≠.</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- MODAL DE DETALLES DEL TRABAJO -->
    <div class="modal-detalles-overlay" id="modalDetalles">
        <div class="modal-detalles-content">
            <div class="modal-detalles-header">
                <div class="detalles-info">
                    <h2 id="detallesEspecializacion">Especializaci√≥n</h2>
                    <div class="detalles-cliente" id="detallesCliente">Cliente: </div>
                    <span class="detalles-estado" id="detallesEstado">Pendiente</span>
                </div>
                <button class="close-detalles-modal">&times;</button>
            </div>
            
            <div class="modal-detalles-body">
                <div class="detalles-section">
                    <h3>Informaci√≥n del Trabajo</h3>
                    <div class="detalles-grid">
                        <div class="detalle-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span class="label">Ubicaci√≥n:</span>
                            <span class="value" id="detallesUbicacion">-</span>
                        </div>
                        <div class="detalle-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="label">Fecha solicitada:</span>
                            <span class="value" id="detallesFecha">-</span>
                        </div>
                        <div class="detalle-item">
                            <i class="fas fa-credit-card"></i>
                            <span class="label">M√©todo de pago:</span>
                            <span class="value" id="detallesPago">-</span>
                        </div>
                        <div class="detalle-item">
                            <i class="fas fa-clock"></i>
                            <span class="label">Solicitado el:</span>
                            <span class="value" id="detallesSolicitud">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="detalles-section">
                    <h3>Especificaciones del Cliente</h3>
                    <div class="especificaciones-content" id="detallesEspecificaciones">
                        No hay especificaciones disponibles.
                    </div>
                </div>
                
                <div class="detalles-section" id="seccionComentariosTrabajador" style="display: none;">
                    <h3>Tus Comentarios Anteriores</h3>
                    <div class="especificaciones-content" style="border-left-color: #ff9800;" id="detallesComentariosTrabajador">
                        <!-- Los comentarios se cargan din√°micamente -->
                    </div>
                </div>
            </div>
            
            <div class="modal-detalles-footer">
                <button class="btn-detalles btn-devolver-detalles" data-action="devolver-desde-detalles">
                    <i class="fas fa-redo"></i> Devolver
                </button>
                <button class="btn-detalles btn-rechazar-detalles" data-action="rechazar-desde-detalles">
                    <i class="fas fa-times"></i> Rechazar
                </button>
                <button class="btn-detalles btn-aceptar-detalles" data-action="aceptar-desde-detalles">
                    <i class="fas fa-check"></i> Aceptar Trabajo
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLES MENTOR√çA -->
    <div class="modal-detalles-mentoria-overlay" id="modalDetallesMentoria">
        <div class="modal-detalles-mentoria-content">
            <div class="modal-detalles-mentoria-header">
                <div class="detalles-mentoria-info">
                    <h2 id="detallesMentoriaAreaInteres">Mentor√≠a - √Årea de Inter√©s</h2>
                    <div class="detalles-mentoria-aprendiz" id="detallesMentoriaAprendiz">Aprendiz: </div>
                    <span class="detalles-mentoria-estado" id="detallesMentoriaEstado">Pendiente</span>
                </div>
                <button class="close-detalles-mentoria-modal">&times;</button>
            </div>
            
            <div class="modal-detalles-mentoria-body">
                <div class="detalles-mentoria-section">
                    <h3>Informaci√≥n de la Solicitud</h3>
                    <div class="detalles-mentoria-grid">
                        <div class="detalle-mentoria-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span class="label">√Årea de inter√©s:</span>
                            <span class="value" id="detallesMentoriaArea">-</span>
                        </div>
                        <div class="detalle-mentoria-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="label">Solicitado el:</span>
                            <span class="value" id="detallesMentoriaFecha">-</span>
                        </div>
                        <div class="detalle-mentoria-item">
                            <i class="fas fa-user-graduate"></i>
                            <span class="label">Tipo:</span>
                            <span class="value">Solicitud de Mentor√≠a</span>
                        </div>
                    </div>
                </div>
                
                <div class="detalles-mentoria-section">
                    <h3>Objetivos de Aprendizaje</h3>
                    <div class="objetivos-content" id="detallesMentoriaObjetivos">
                        No hay objetivos especificados.
                    </div>
                </div>
                
                <div class="detalles-mentoria-section">
                    <h3>Disponibilidad del Aprendiz</h3>
                    <div class="disponibilidad-content" id="detallesMentoriaDisponibilidad">
                        No hay disponibilidad especificada.
                    </div>
                </div>
            </div>
            
            <div class="modal-detalles-mentoria-footer">
                <button class="btn-detalles-mentoria btn-rechazar-mentoria-detalles" data-action="rechazar-desde-detalles-mentoria">
                    <i class="fas fa-times"></i> Rechazar
                </button>
                <button class="btn-detalles-mentoria btn-aceptar-mentoria-detalles" data-action="aceptar-desde-detalles-mentoria">
                    <i class="fas fa-check"></i> Aceptar Mentor√≠a
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA ESPECIFICAR PRECIO -->
    <div class="modal-precio-overlay" id="modalPrecio">
        <div class="modal-precio-content">
            <div class="modal-precio-header">
                <h2>Especificar Precio del Trabajo</h2>
                <button class="close-precio-modal">&times;</button>
            </div>
            
            <div class="modal-precio-body">
                <div class="precio-form-group">
                    <label for="inputPrecioEstimado">Precio estimado (ARS):</label>
                    <div class="precio-input-group">
                        <span class="precio-symbol">$</span>
                        <input type="number" id="inputPrecioEstimado" placeholder="Ej: 5000" min="1" step="100">
                    </div>
                    <div class="precio-info">
                        <i class="fas fa-info-circle"></i>
                        Este precio se mostrar√° al cliente para que realice el pago por MercadoPago.
                    </div>
                </div>
            </div>
            
            <div class="modal-precio-footer">
                <button class="btn-precio btn-cancelar-precio" data-action="cancelar-precio">
                    Cancelar
                </button>
                <button class="btn-precio btn-confirmar-precio" data-action="confirmar-precio">
                    <i class="fas fa-check"></i> Confirmar Precio y Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para devolver trabajo -->
    <div class="modal-overlay" id="modalDevolucion">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Devolver Solicitud</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="formDevolucion">
                <input type="hidden" id="trabajoIdDevolucion" value="">
                <div class="form-group">
                    <label for="especificacionesTrabajador">Especificaciones adicionales:</label>
                    <textarea id="especificacionesTrabajador" placeholder="Explique por qu√© devuelve la solicitud o qu√© informaci√≥n adicional necesita del cliente..." required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" data-action="cancelar-devolucion">Cancelar</button>
                    <button type="button" class="btn btn-submit" data-action="enviar-devolucion">Enviar Devoluci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Variables globales
    let trabajoActualId = '';
    let trabajoActualTipo = '';
    let mentoriaActualId = '';

    // Delegaci√≥n de eventos para evitar onclick
    document.addEventListener('DOMContentLoaded', function() {
        // Eventos para tarjetas de trabajo (contrataciones)
        document.querySelectorAll('.job-card[data-tipo="contratacion"]').forEach(card => {
            const trabajoId = card.dataset.id;
            
            card.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', function(e) {
                    const action = this.dataset.action;
                    e.stopPropagation();
                    
                    switch(action) {
                        case 'ver-detalles':
                            verDetalles(trabajoId);
                            break;
                        case 'aceptar':
                            aceptarTrabajo(trabajoId, 'contratacion');
                            break;
                        case 'rechazar':
                            rechazarTrabajo(trabajoId, 'contratacion');
                            break;
                        case 'devolver':
                            abrirModalDevolucion(trabajoId);
                            break;
                    }
                });
            });
        });

        // Eventos para tarjetas de mentor√≠a
        document.querySelectorAll('.job-card[data-tipo="mentoria"]').forEach(card => {
            const mentoriaId = card.dataset.id;
            
            card.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', function(e) {
                    const action = this.dataset.action;
                    e.stopPropagation();
                    
                    switch(action) {
                        case 'ver-detalles-mentoria':
                            verDetallesMentoria(mentoriaId);
                            break;
                        case 'aceptar-mentoria':
                            aceptarMentoria(mentoriaId);
                            break;
                        case 'rechazar-mentoria':
                            rechazarMentoria(mentoriaId);
                            break;
                    }
                });
            });
        });

        // Eventos para modal de detalles
        document.querySelectorAll('[data-action="aceptar-desde-detalles"]').forEach(btn => {
            btn.addEventListener('click', aceptarDesdeDetalles);
        });
        
        document.querySelectorAll('[data-action="rechazar-desde-detalles"]').forEach(btn => {
            btn.addEventListener('click', rechazarDesdeDetalles);
        });
        
        document.querySelectorAll('[data-action="devolver-desde-detalles"]').forEach(btn => {
            btn.addEventListener('click', devolverDesdeDetalles);
        });

        // Eventos para modal de mentor√≠a detalles
        document.querySelectorAll('[data-action="aceptar-desde-detalles-mentoria"]').forEach(btn => {
            btn.addEventListener('click', aceptarDesdeDetallesMentoria);
        });
        
        document.querySelectorAll('[data-action="rechazar-desde-detalles-mentoria"]').forEach(btn => {
            btn.addEventListener('click', rechazarDesdeDetallesMentoria);
        });

        // Eventos para modal de precio
        document.querySelectorAll('[data-action="cancelar-precio"]').forEach(btn => {
            btn.addEventListener('click', cerrarModalPrecio);
        });
        
        document.querySelectorAll('[data-action="confirmar-precio"]').forEach(btn => {
            btn.addEventListener('click', confirmarAceptacionConPrecio);
        });

        // Eventos para modal de devoluci√≥n
        document.querySelectorAll('[data-action="cancelar-devolucion"]').forEach(btn => {
            btn.addEventListener('click', cerrarModalDevolucion);
        });
        
        document.querySelectorAll('[data-action="enviar-devolucion"]').forEach(btn => {
            btn.addEventListener('click', devolverTrabajo);
        });

        // Botones de cierre de modales
        document.querySelectorAll('.close-modal, .close-detalles-modal, .close-detalles-mentoria-modal, .close-precio-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay, .modal-detalles-overlay, .modal-detalles-mentoria-overlay, .modal-precio-overlay');
                if (modal.id === 'modalDetalles') cerrarModalDetalles();
                else if (modal.id === 'modalDetallesMentoria') cerrarModalDetallesMentoria();
                else if (modal.id === 'modalPrecio') cerrarModalPrecio();
                else if (modal.id === 'modalDevolucion') cerrarModalDevolucion();
            });
        });

        // Cerrar modales al hacer clic fuera
        document.getElementById('modalDetalles').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalDetalles();
        });
        
        document.getElementById('modalDetallesMentoria').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalDetallesMentoria();
        });
        
        document.getElementById('modalPrecio').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalPrecio();
        });
        
        document.getElementById('modalDevolucion').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalDevolucion();
        });

        // Enter en input de precio
        document.getElementById('inputPrecioEstimado').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                confirmarAceptacionConPrecio();
            }
        });
    });

    // Funciones principales
    function abrirModalDevolucion(trabajoId) {
        trabajoActualId = trabajoId;
        document.getElementById('trabajoIdDevolucion').value = trabajoId;
        document.getElementById('especificacionesTrabajador').value = '';
        document.getElementById('modalDevolucion').style.display = 'flex';
    }
    
    function cerrarModalDevolucion() {
        document.getElementById('modalDevolucion').style.display = 'none';
        trabajoActualId = '';
    }
    
    function aceptarTrabajo(trabajoId, tipo) {
        if (tipo === 'mentoria') {
            aceptarMentoria(trabajoId);
            return;
        }
        
        trabajoActualId = trabajoId;
        trabajoActualTipo = tipo;
        document.getElementById('inputPrecioEstimado').value = '';
        document.getElementById('modalPrecio').classList.add('active');
    }

    function rechazarTrabajo(trabajoId, tipo) {
        const url = tipo === 'contratacion' ? `/rechazar_trabajo/${trabajoId}` : `/rechazar_mentoria/${trabajoId}`;
        const mensaje = tipo === 'contratacion' ? 'trabajo' : 'mentor√≠a';
        
        if (confirm(`¬øEst√°s seguro de que quieres rechazar este ${mensaje}?`)) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`${tipo === 'contratacion' ? 'Trabajo' : 'Mentor√≠a'} rechazado`);
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la solicitud. Verifica que la ruta exista en el servidor.');
            });
        }
    }

    function devolverTrabajo() {
        const especificaciones = document.getElementById('especificacionesTrabajador').value.trim();
        
        if (!especificaciones) {
            alert('Por favor, ingrese las especificaciones adicionales.');
            return;
        }
        
        fetch(`/devolver_trabajo/${trabajoActualId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                especificaciones: especificaciones
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Solicitud devuelta con √©xito');
                cerrarModalDevolucion();
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud. Verifica que la ruta /devolver_trabajo exista.');
        });
    }

    function verDetalles(trabajoId) {
        const trabajoCard = document.querySelector(`.job-card[data-id="${trabajoId}"]`);
        
        if (trabajoCard) {
            const titulo = trabajoCard.querySelector('h3').textContent;
            const especializacion = titulo.replace('Solicitud de ', '');
            
            const descripcionParrafos = trabajoCard.querySelectorAll('.job-description p');
            let cliente = 'Cliente no disponible';
            let especificaciones = 'No hay especificaciones disponibles';
            
            if (descripcionParrafos.length >= 1) {
                cliente = descripcionParrafos[0].textContent.replace('Cliente: ', '');
            }
            if (descripcionParrafos.length >= 2) {
                especificaciones = descripcionParrafos[1].textContent.replace('Especificaciones: ', '');
            }
            
            const detalles = trabajoCard.querySelectorAll('.job-details .detail');
            let ubicacion = 'Ubicaci√≥n no especificada';
            let fechaTrabajo = 'Fecha no especificada';
            let metodoPago = 'M√©todo no especificado';
            let fechaSolicitud = 'Fecha no disponible';
            
            detalles.forEach(detalle => {
                const icono = detalle.querySelector('i');
                const texto = detalle.textContent.trim();
                
                if (icono.classList.contains('fa-map-marker-alt')) {
                    ubicacion = texto.replace('üìç', '').trim();
                } else if (icono.classList.contains('fa-calendar-alt')) {
                    fechaTrabajo = texto.replace('Fecha solicitada:', '').trim();
                } else if (icono.classList.contains('fa-credit-card')) {
                    metodoPago = texto.replace('M√©todo de pago:', '').trim();
                } else if (icono.classList.contains('fa-clock')) {
                    fechaSolicitud = texto.replace('Solicitado el:', '').trim();
                }
            });
            
            document.getElementById('detallesEspecializacion').textContent = especializacion;
            document.getElementById('detallesCliente').textContent = 'Cliente: ' + cliente;
            document.getElementById('detallesUbicacion').textContent = ubicacion;
            document.getElementById('detallesFecha').textContent = fechaTrabajo;
            document.getElementById('detallesPago').textContent = metodoPago;
            document.getElementById('detallesSolicitud').textContent = fechaSolicitud;
            document.getElementById('detallesEspecificaciones').textContent = especificaciones;
            
            const esUrgente = trabajoCard.classList.contains('highlighted');
            document.getElementById('detallesEstado').textContent = esUrgente ? '‚ö†Ô∏è Urgente' : 'Pendiente';
            document.getElementById('seccionComentariosTrabajador').style.display = 'none';
            document.getElementById('modalDetalles').classList.add('active');
            document.getElementById('modalDetalles').dataset.trabajoId = trabajoId;
            
        } else {
            alert('Error: No se pudieron cargar los detalles del trabajo.');
        }
    }

    function cerrarModalDetalles() {
        document.getElementById('modalDetalles').classList.remove('active');
    }

    function aceptarDesdeDetalles() {
        const trabajoId = document.getElementById('modalDetalles').dataset.trabajoId;
        const trabajoCard = document.querySelector(`.job-card[data-id="${trabajoId}"]`);
        const tipo = trabajoCard.dataset.tipo;
        
        cerrarModalDetalles();
        aceptarTrabajo(trabajoId, tipo);
    }

    function rechazarDesdeDetalles() {
        const trabajoId = document.getElementById('modalDetalles').dataset.trabajoId;
        const trabajoCard = document.querySelector(`.job-card[data-id="${trabajoId}"]`);
        const tipo = trabajoCard.dataset.tipo;
        
        cerrarModalDetalles();
        rechazarTrabajo(trabajoId, tipo);
    }

    function devolverDesdeDetalles() {
        const trabajoId = document.getElementById('modalDetalles').dataset.trabajoId;
        cerrarModalDetalles();
        abrirModalDevolucion(trabajoId);
    }

    // Funciones para mentor√≠as
    function aceptarMentoria(mentoriaId) {
        if (confirm('¬øEst√°s seguro de que quieres aceptar esta solicitud de mentor√≠a?')) {
            fetch(`/aceptar_mentoria/${mentoriaId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Mentor√≠a aceptada con √©xito');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la solicitud. Verifica que la ruta /aceptar_mentoria exista.');
            });
        }
    }

    function rechazarMentoria(mentoriaId) {
        if (confirm('¬øEst√°s seguro de que quieres rechazar esta solicitud de mentor√≠a?')) {
            fetch(`/rechazar_mentoria/${mentoriaId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Mentor√≠a rechazada');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la solicitud. Verifica que la ruta /rechazar_mentoria exista.');
            });
        }
    }

    function verDetallesMentoria(mentoriaId) {
        const mentoriaCard = document.querySelector(`.job-card[data-id="${mentoriaId}"]`);
        
        if (mentoriaCard) {
            const titulo = mentoriaCard.querySelector('h3').textContent;
            const areaInteres = titulo.replace('Solicitud de Mentor√≠a - ', '');
            
            const descripcionParrafos = mentoriaCard.querySelectorAll('.job-description p');
            let aprendiz = 'Aprendiz no disponible';
            let objetivos = 'No hay objetivos disponibles';
            
            if (descripcionParrafos.length >= 1) {
                aprendiz = descripcionParrafos[0].textContent.replace('Aprendiz: ', '');
            }
            if (descripcionParrafos.length >= 2) {
                objetivos = descripcionParrafos[1].textContent.replace('Objetivos: ', '');
            }
            
            const detalles = mentoriaCard.querySelectorAll('.job-details .detail');
            let disponibilidad = 'Disponibilidad no especificada';
            let fechaSolicitud = 'Fecha no disponible';
            
            detalles.forEach(detalle => {
                const icono = detalle.querySelector('i');
                const texto = detalle.textContent.trim();
                
                if (icono.classList.contains('fa-clock')) {
                    disponibilidad = texto.replace('Disponibilidad:', '').trim();
                } else if (icono.classList.contains('fa-calendar-alt')) {
                    fechaSolicitud = texto.replace('Solicitado el:', '').trim();
                }
            });
            
            document.getElementById('detallesMentoriaAreaInteres').textContent = `Mentor√≠a - ${areaInteres}`;
            document.getElementById('detallesMentoriaAprendiz').textContent = 'Aprendiz: ' + aprendiz;
            document.getElementById('detallesMentoriaArea').textContent = areaInteres;
            document.getElementById('detallesMentoriaFecha').textContent = fechaSolicitud;
            document.getElementById('detallesMentoriaObjetivos').textContent = objetivos;
            document.getElementById('detallesMentoriaDisponibilidad').textContent = disponibilidad;
            document.getElementById('modalDetallesMentoria').classList.add('active');
            document.getElementById('modalDetallesMentoria').dataset.mentoriaId = mentoriaId;
            
        } else {
            alert('Error: No se pudieron cargar los detalles de la mentor√≠a.');
        }
    }

    function cerrarModalDetallesMentoria() {
        document.getElementById('modalDetallesMentoria').classList.remove('active');
    }

    function aceptarDesdeDetallesMentoria() {
        const mentoriaId = document.getElementById('modalDetallesMentoria').dataset.mentoriaId;
        cerrarModalDetallesMentoria();
        aceptarMentoria(mentoriaId);
    }

    function rechazarDesdeDetallesMentoria() {
        const mentoriaId = document.getElementById('modalDetallesMentoria').dataset.mentoriaId;
        cerrarModalDetallesMentoria();
        rechazarMentoria(mentoriaId);
    }

    // Funciones para precio
    function cerrarModalPrecio() {
        document.getElementById('modalPrecio').classList.remove('active');
        trabajoActualId = '';
        trabajoActualTipo = '';
    }

    function confirmarAceptacionConPrecio() {
        const precioInput = document.getElementById('inputPrecioEstimado');
        const precio = parseFloat(precioInput.value);
        
        if (!precio || precio <= 0 || isNaN(precio)) {
            alert('Por favor ingresa un precio v√°lido mayor a 0');
            precioInput.focus();
            return;
        }
        
        if (!confirm(`¬øConfirmas aceptar el trabajo con un precio de $${precio}?`)) {
            return;
        }
        
        cerrarModalPrecio();
        
        fetch(`/aceptar_trabajo/${trabajoActualId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                precio: precio
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Trabajo aceptado con √©xito! Se notificar√° al cliente.');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud. Verifica que la ruta /aceptar_trabajo exista.');
        });
    }

    // Manejo de errores de red mejorado
    window.addEventListener('error', function(e) {
        if (e.message.includes('Failed to fetch') || e.message.includes('404')) {
            console.error('Error de red o ruta no encontrada:', e);
        }
    });
    </script>
</body>
</html>