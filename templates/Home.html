<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Fix - Soluciones Rápidas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='Home.css') }}">
</head>
<style>
/* SOLO ESTILOS DEL MODAL DE RATING */
.modal-perfil-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.modal-perfil-overlay.active {
    display: flex;
}

.modal-perfil-content {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-perfil-header {
    background: #2563eb;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.perfil-info h2 {
    margin: 0;
    font-size: 1.3rem;
}

.perfil-especialidad {
    font-size: 0.9rem;
    opacity: 0.9;
}

.close-perfil-modal {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.modal-perfil-body {
    padding: 20px;
}

.perfil-section {
    margin-bottom: 20px;
}

.perfil-section h3 {
    margin-bottom: 15px;
    color: #333;
}

/* ESTRELLAS */
.estrellas-container-perfil {
    text-align: center;
    margin: 15px 0;
}

.estrellas-calificacion-perfil {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
}

.estrella-perfil {
    font-size: 2rem;
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s;
}

.estrella-perfil.active {
    color: #ffd700;
}

.estrella-perfil:hover {
    color: #ffd700;
}

.calificacion-texto-perfil {
    padding: 10px;
    background: #f5f5f5;
    border-radius: 5px;
    margin-top: 10px;
}

/* COMENTARIO */
.comentario-input-full textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    resize: vertical;
    min-height: 80px;
}

.contador-caracteres-perfil {
    text-align: right;
    font-size: 0.8rem;
    color: #666;
    margin-top: 5px;
}

/* BOTONES */
.modal-perfil-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-perfil {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
}

.btn-cancelar-perfil {
    background: #6c757d;
    color: white;
}

.btn-contratar {
    background: #2563eb;
    color: white;
}
</style>
<body>
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
        <div class="line line-4"></div>
    </div>

    <!-- Solo Botón de Chat Flotante -->
    {% if session.get('is_logged_in') %}
            <!-- Botones Flotantes -->
    {% if session.get('is_logged_in') %}
    <div class="floating-buttons">
        <!-- Botón del Muro - Solo para clientes (1) y trabajadores (2) -->
        {% if session.get('user_type') == '1' or session.get('user_type') == '2' %}
        <div class="chat-icon muro-icon" id="muroButton">
            <i class="fas fa-newspaper"></i>
        </div>
        {% endif %}
        
        <!-- Botón de Chat -->
        <div class="chat-icon" id="chatButton">
            <i class="fas fa-comments"></i>
            {% if session.get('total_mensajes_no_leidos', 0) > 0 %}
            <span class="chat-notification-badge">{{ session.get('total_mensajes_no_leidos', 0) }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <div class="container">
        <header class="header">
            <div class="logo">Quick<span>Fix</span></div>
            <nav class="nav">
                <a href="#" class="nav-item active">Sobre nosotros</a>
                <a href="#" class="nav-item">Reseñas</a>
                <a href="#" class="nav-item">Servicios</a>
                <a href="#" class="nav-item">Ayuda</a>
                
                {% if session.get('is_logged_in') %}
                    <span class="user-info">
                        {{ session.get('user_name', 'Usuario') }}
                        <span class="user-badge">
                            {% if session.get('user_type') == '1' %}Cliente
                            {% elif session.get('user_type') == '2' %}Trabajador
                            {% else %}Desempleado{% endif %}
                        </span>
                    </span>
                    <a href="/logout" class="nav-item logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </a>
                {% else %}
                    <a href="/" class="nav-item login-btn">
                        <i class="fas fa-sign-in-alt"></i> Ingresar
                    </a>
                    <a href="/registro" class="nav-item register-btn">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </a>
                {% endif %}
            </nav>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </header>
        
        <main class="main-content">
            <div class="hero-text">
                {% if session.get('is_logged_in') %}
                    <div class="tagline">Bienvenido de vuelta</div>
                    <h1 class="title">
                        {% if session.get('user_type') == '1' %}
                            Soluciones <span>personalizadas</span> para ti
                        {% elif session.get('user_type') == '2' %}
                            Oportunidades <span>laborales</span> disponibles
                        {% else %}
                            Encuentra tu próximo <span>empleo</span>
                        {% endif %}
                    </h1>
                    <p class="description">
                        {% if session.get('user_type') == '1' %}
                            Conectamos con los mejores profesionales para resolver tus problemas domésticos.
                        {% elif session.get('user_type') == '2' %}
                            Trabajos que se ajustan a tus habilidades y experiencia profesional.
                        {% else %}
                            Oportunidades de capacitación y empleo adaptadas a tu perfil.
                        {% endif %}
                    </p>
                {% else %}
                    <div class="tagline">Soluciones a tu alcance</div>
                    <h1 class="title">Servicios rápidos y <span>confiables</span> cuando más los necesitas</h1>
                    <p class="description">Conectamos usuarios con profesionales certificados para resolver problemas técnicos y domésticos.</p>
                {% endif %}

                <div class="cta-container">
                    {% if session.get('is_logged_in') %}
                        {% if session.get('user_type') == '1' %}
                            <a href="{{ url_for('browser') }}" class="cta-button primary">
                                Buscar profesionales <i class="fas fa-arrow-right"></i>
                            </a>
                            
                            <a href="{{ url_for('mis_solicitudes') }}" class="cta-button secondary">
                                Mis solicitudes
                            </a>
                       {% elif session.get('user_type') == '2' %}
                            <div class="solicitudes-container" style="position: relative; display: inline-block;">
                                <a href="{{ url_for('trabajos') }}" class="cta-button primary">
                                    Solicitudes <i class="fas fa-arrow-right"></i>
                                </a>
                                {% if solicitudes_pendientes > 0 %}
                                <span class="notification-badge">{{ solicitudes_pendientes }}</span>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('trabajos_pendientes') }}" class="cta-button secondary">
                                Trabajos pendientes
                            </a>
                        {% else %}
                            <a href="/oportunidades" class="cta-button primary">
                                Oportunidades <i class="fas fa-arrow-right"></i>
                            </a>
                            <a href="/capacitaciones" class="cta-button secondary">
                                Mis capacitaciones
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="/" class="cta-button primary">
                            Iniciar sesión <i class="fas fa-sign-in-alt"></i>
                        </a>
                        <a href="/registro" class="cta-button secondary">
                            Registrarse
                        </a>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

<!-- POPUP DE PAGO PENDIENTE -->
<div class="modal-perfil-overlay" id="modalPagoPendiente" style="display:none;">
    <div class="modal-perfil-content">
        
        <div class="modal-perfil-header" style="background:#ff9800;">
            <h2>Pago Pendiente</h2>
            <button class="close-perfil-modal" onclick="cerrarPopupPago()">&times;</button>
        </div>

        <div class="modal-perfil-body">
            <p id="popupTextoPago" style="font-size:1.1rem; text-align:center;"></p>
        </div>

        <div class="modal-perfil-footer">
            <button class="btn-perfil btn-cancelar-perfil" onclick="cerrarPopupPago()">
                Más tarde
            </button>

            <button class="btn-perfil btn-contratar" onclick="redirigirAPago()">
                Ir a pagar ahora
            </button>
        </div>

    </div>
</div>


<div class="modal-perfil-overlay" id="modalCalificacion">
    <div class="modal-perfil-content">
        <div class="modal-perfil-header">
            <div class="perfil-info">
                <h2 id="calificacionTitulo">Calificar Servicio</h2>
                <div class="perfil-especialidad" id="calificacionSubtitulo">Tu opinión ayuda a mejorar nuestra comunidad</div>
            </div>
            <button class="close-perfil-modal" onclick="cerrarModalCalificacion()">&times;</button>
        </div>
        
        <div class="modal-perfil-body">
            <form id="formCalificacion">
                <input type="hidden" id="tipoServicio" value="">
                <input type="hidden" id="servicioId" value="">
                <input type="hidden" id="profesionalId" value="">
                
                <div class="perfil-section">
                    <h3>¿Cómo calificarías el servicio recibido?</h3>
                    <div class="estrellas-container-perfil">
                        <div class="estrellas-calificacion-perfil">
                            <span class="estrella-perfil" data-value="1">
                                <i class="far fa-star"></i>
                            </span>
                            <span class="estrella-perfil" data-value="2">
                                <i class="far fa-star"></i>
                            </span>
                            <span class="estrella-perfil" data-value="3">
                                <i class="far fa-star"></i>
                            </span>
                            <span class="estrella-perfil" data-value="4">
                                <i class="far fa-star"></i>
                            </span>
                            <span class="estrella-perfil" data-value="5">
                                <i class="far fa-star"></i>
                            </span>
                        </div>
                        <div class="calificacion-texto-perfil">
                            <span id="textoCalificacion">Selecciona una calificación</span>
                        </div>
                    </div>
                    <input type="hidden" id="valorCalificacion" value="0">
                </div>

                <div class="perfil-section">
                    <h3>Comparte tu experiencia</h3>
                    <div class="comentario-section-perfil">
                        <div class="detail-item">
                            <i class="fas fa-edit"></i>
                            <div class="comentario-input-full">
                                <textarea id="comentarioCalificacion" placeholder="¿Qué te pareció el servicio? ¿Algo que destacar o mejorar? (opcional)" rows="4"></textarea>
                                <div class="contador-caracteres-perfil">
                                    <span id="contadorCaracteres">0</span>/500 caracteres
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="modal-perfil-footer">
            <button class="btn-perfil btn-cancelar-perfil" onclick="cerrarModalCalificacion()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-perfil btn-contratar" onclick="enviarCalificacion()">
                <i class="fas fa-paper-plane"></i> Enviar Calificación
            </button>
        </div>
    </div>
</div>

    <script>

let trabajoPendienteID = "";

function abrirPopupPagoPendiente(trabajo) {
    trabajoPendienteID = trabajo.id;

    document.getElementById('popupTextoPago').innerText =
        `${trabajo.trabajador_nombre} aceptó tu solicitud.\n` +
        `Como seleccionaste Mercado Pago, debés pagar ahora para confirmar el trabajo.`;

    document.getElementById('modalPagoPendiente').style.display = "flex";
}

function cerrarPopupPago() {
    document.getElementById('modalPagoPendiente').style.display = "none";
}

function redirigirAPago() {
    window.location.href = `/crear-pago/${trabajoPendienteID}`;
}

function verificarPagosPendientes() {
    fetch('/api/pagos_pendientes')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.trabajos.length > 0) {
                abrirPopupPagoPendiente(data.trabajos[0]);
            }
        });
}

document.addEventListener('DOMContentLoaded', () => {
    verificarPagosPendientes();
});

// Detectar calificaciones pendientes al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si el usuario está logueado y es cliente (tipo 1) o desempleado (tipo 3)
    const userType = "{{ session.get('user_type', '') }}";
    const isLoggedIn = "{{ session.get('is_logged_in', False) }}" === "True";
    
    if (isLoggedIn && (userType === '1' || userType === '3')) {
        verificarCalificacionesPendientes();
    }

    // Inicializar botones flotantes
    inicializarBotonesFlotantes();
});

function verificarCalificacionesPendientes() {
    fetch('/api/calificaciones_pendientes')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.calificaciones_pendientes.length > 0) {
                // Mostrar el primer trabajo/mentoría pendiente de calificar
                const primeraCalificacion = data.calificaciones_pendientes[0];
                mostrarModalCalificacion(primeraCalificacion);
            }
        })
        .catch(error => console.error('Error:', error));
}

function mostrarModalCalificacion(calificacion) {
    document.getElementById('tipoServicio').value = calificacion.tipo;
    document.getElementById('servicioId').value = calificacion.id;
    document.getElementById('profesionalId').value = calificacion.profesional_id;
    
    // Configurar título según el tipo
    const titulo = calificacion.tipo === 'trabajo' ? 'Calificar Trabajo' : 'Calificar Mentoría';
    const subtitulo = calificacion.tipo === 'trabajo' 
        ? `Servicio: ${calificacion.titulo}` 
        : `Mentoría: ${calificacion.titulo}`;
    
    document.getElementById('calificacionTitulo').textContent = titulo;
    document.getElementById('calificacionSubtitulo').textContent = subtitulo;
    
    // AGREGAR INFORMACIÓN DEL PROFESIONAL
    const profesionalInfo = `
        <div class="profesional-info">
            <p><strong>Profesional:</strong> ${calificacion.profesional_nombre || 'Nombre no disponible'}</p>
            <p><strong>Servicio:</strong> ${calificacion.titulo}</p>
            ${calificacion.fecha ? `<p><strong>Fecha:</strong> ${calificacion.fecha}</p>` : ''}
        </div>
    `;
    
    // Insertar la info del profesional al inicio del modal body
    const modalBody = document.querySelector('.modal-perfil-body');
    const firstSection = modalBody.querySelector('.perfil-section');
    modalBody.insertAdjacentHTML('afterbegin', profesionalInfo);
    
    // Mostrar modal
    document.getElementById('modalCalificacion').classList.add('active');
}

// Función para enviar calificación
function enviarCalificacion() {
    const tipo = document.getElementById('tipoServicio').value;
    const servicioId = document.getElementById('servicioId').value;
    const profesionalId = document.getElementById('profesionalId').value;
    const calificacion = document.getElementById('valorCalificacion').value;
    const comentario = document.getElementById('comentarioCalificacion').value;

    if (calificacion === '0') {
        alert('Por favor selecciona una calificación');
        return;
    }

    const url = tipo === 'trabajo' ? '/calificar_trabajo/' : '/calificar_mentoria_desempleado/';
    
    fetch(url + servicioId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            calificacion: parseInt(calificacion),
            comentario: comentario,
            trabajadorId: profesionalId,
            mentorId: profesionalId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('¡Gracias por tu calificación!');
            cerrarModalCalificacion();
            // Verificar si hay más calificaciones pendientes
            verificarCalificacionesPendientes();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la calificación');
    });
}

function cerrarModalCalificacion() {
    document.getElementById('modalCalificacion').classList.remove('active');
    // Limpiar formulario
    document.getElementById('valorCalificacion').value = '0';
    document.getElementById('comentarioCalificacion').value = '';
    // Resetear estrellas
    document.querySelectorAll('.estrella-perfil').forEach(star => {
        star.classList.remove('active');
    });
    document.getElementById('textoCalificacion').textContent = 'Selecciona una calificación';
    document.getElementById('contadorCaracteres').textContent = '0';
}

// Sistema de estrellas NUEVO
document.querySelectorAll('.estrella-perfil').forEach(star => {
    star.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        document.getElementById('valorCalificacion').value = value;
        
        // Actualizar visualización de estrellas
        document.querySelectorAll('.estrella-perfil').forEach(s => {
            s.classList.remove('active');
            if (s.getAttribute('data-value') <= value) {
                s.classList.add('active');
            }
        });
        
        // Actualizar texto
        const textos = {
            '1': 'Muy malo - No cumplió con las expectativas',
            '2': 'Malo - Hubo varios problemas', 
            '3': 'Regular - Cumplió lo básico',
            '4': 'Bueno - Satisfactorio con algunos aspectos destacados',
            '5': 'Excelente - Superó todas las expectativas'
        };
        document.getElementById('textoCalificacion').textContent = textos[value];
    });
});

// Cerrar modal al hacer click fuera (nuevo)
document.getElementById('modalCalificacion').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalCalificacion();
    }
});

// Contador de caracteres para comentario
document.getElementById('comentarioCalificacion')?.addEventListener('input', function() {
    const contador = document.getElementById('contadorCaracteres');
    if (contador) {
        contador.textContent = this.value.length;
    }
});

// Botones flotantes
function inicializarBotonesFlotantes() {
    console.log('DOM cargado - inicializando botones flotantes');
    
    // Botón del Muro
    const muroButton = document.getElementById('muroButton');
    console.log('Botón muro encontrado:', muroButton);
    
    if (muroButton) {
        muroButton.addEventListener('click', function() {
            console.log('Clic en muro - redirigiendo...');
            window.location.href = '/muro_publicaciones';
        });
    }

    // Botón del Chat
    const chatButton = document.getElementById('chatButton');
    console.log('Botón chat encontrado:', chatButton);
    
    if (chatButton) {
        chatButton.addEventListener('click', function() {
            console.log('Clic en chat - redirigiendo...');
            window.location.href = '/chat_home';
        });
    }
}

// Función toggleComentario (si aún la necesitas, aunque ahora el comentario siempre está visible)
function toggleComentario() {
    const textarea = document.getElementById('comentarioCalificacion');
    const button = document.querySelector('.btn-toggle-comentario');
    
    if (textarea.style.display === 'none' || textarea.style.display === '') {
        textarea.style.display = 'block';
        button.innerHTML = '<i class="fas fa-times"></i> Ocultar comentario';
    } else {
        textarea.style.display = 'none';
        button.innerHTML = '<i class="fas fa-comment"></i> Agregar comentario';
    }
}
</script>


</body>
</html>