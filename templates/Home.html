<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Fix - Soluciones Rápidas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='Home.css') }}">
</head>

<body>
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
        <div class="line line-4"></div>
    </div>

    <!-- Solo Botón de Chat Flotante -->
    {% if session.get('is_logged_in') %}
            <!-- Botones Flotantes -->
    {% if session.get('is_logged_in') %}
    <div class="floating-buttons">
        <!-- Botón del Muro - Solo para clientes (1) y trabajadores (2) -->
        {% if session.get('user_type') == '1' or session.get('user_type') == '2' %}
        <div class="chat-icon muro-icon" id="muroButton">
            <i class="fas fa-newspaper"></i>
        </div>
        {% endif %}
        
        <!-- Botón de Chat -->
        <div class="chat-icon" id="chatButton">
            <i class="fas fa-comments"></i>
            {% if session.get('total_mensajes_no_leidos', 0) > 0 %}
            <span class="chat-notification-badge">{{ session.get('total_mensajes_no_leidos', 0) }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <div class="container">
        <header class="header">
            <div class="logo">Quick<span>Fix</span></div>
            <nav class="nav">
                <a href="#" class="nav-item active">Sobre nosotros</a>
                <a href="#" class="nav-item">Reseñas</a>
                <a href="#" class="nav-item">Servicios</a>
                <a href="#" class="nav-item">Ayuda</a>
                
                {% if session.get('is_logged_in') %}
                    <span class="user-info">
                        {{ session.get('user_name', 'Usuario') }}
                        <span class="user-badge">
                            {% if session.get('user_type') == '1' %}Cliente
                            {% elif session.get('user_type') == '2' %}Trabajador
                            {% else %}Desempleado{% endif %}
                        </span>
                    </span>
                    <a href="/logout" class="nav-item logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </a>
                {% else %}
                    <a href="/" class="nav-item login-btn">
                        <i class="fas fa-sign-in-alt"></i> Ingresar
                    </a>
                    <a href="/registro" class="nav-item register-btn">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </a>
                {% endif %}
            </nav>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </header>
        
        <main class="main-content">
            <div class="hero-text">
                {% if session.get('is_logged_in') %}
                    <div class="tagline">Bienvenido de vuelta</div>
                    <h1 class="title">
                        {% if session.get('user_type') == '1' %}
                            Soluciones <span>personalizadas</span> para ti
                        {% elif session.get('user_type') == '2' %}
                            Oportunidades <span>laborales</span> disponibles
                        {% else %}
                            Encuentra tu próximo <span>empleo</span>
                        {% endif %}
                    </h1>
                    <p class="description">
                        {% if session.get('user_type') == '1' %}
                            Conectamos con los mejores profesionales para resolver tus problemas domésticos.
                        {% elif session.get('user_type') == '2' %}
                            Trabajos que se ajustan a tus habilidades y experiencia profesional.
                        {% else %}
                            Oportunidades de capacitación y empleo adaptadas a tu perfil.
                        {% endif %}
                    </p>
                {% else %}
                    <div class="tagline">Soluciones a tu alcance</div>
                    <h1 class="title">Servicios rápidos y <span>confiables</span> cuando más los necesitas</h1>
                    <p class="description">Conectamos usuarios con profesionales certificados para resolver problemas técnicos y domésticos.</p>
                {% endif %}

                <div class="cta-container">
                    {% if session.get('is_logged_in') %}
                        {% if session.get('user_type') == '1' %}
                            <a href="{{ url_for('browser') }}" class="cta-button primary">
                                Buscar profesionales <i class="fas fa-arrow-right"></i>
                            </a>
                            
                            <a href="{{ url_for('mis_solicitudes') }}" class="cta-button secondary">
                                Mis solicitudes
                            </a>
                       {% elif session.get('user_type') == '2' %}
                            <div class="solicitudes-container" style="position: relative; display: inline-block;">
                                <a href="{{ url_for('trabajos') }}" class="cta-button primary">
                                    Solicitudes <i class="fas fa-arrow-right"></i>
                                </a>
                                {% if solicitudes_pendientes > 0 %}
                                <span class="notification-badge">{{ solicitudes_pendientes }}</span>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('trabajos_pendientes') }}" class="cta-button secondary">
                                Trabajos pendientes
                            </a>
                        {% else %}
                            <a href="/oportunidades" class="cta-button primary">
                                Oportunidades <i class="fas fa-arrow-right"></i>
                            </a>
                            <a href="/capacitaciones" class="cta-button secondary">
                                Mis capacitaciones
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="/" class="cta-button primary">
                            Iniciar sesión <i class="fas fa-sign-in-alt"></i>
                        </a>
                        <a href="/registro" class="cta-button secondary">
                            Registrarse
                        </a>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalCalificacion">
    <div class="modal-content calificacion-modal">
        <div class="modal-header">
            <h3 class="modal-title">Calificar Servicio</h3>
            <button class="close-modal" onclick="cerrarModalCalificacion()">&times;</button>
        </div>
        <form id="formCalificacion">
            <input type="hidden" id="tipoServicio" value="">
            <input type="hidden" id="servicioId" value="">
            <input type="hidden" id="profesionalId" value="">
            
            <div class="calificacion-section">
                <label>¿Cómo calificarías el servicio?</label>
                <div class="estrellas-calificacion">
                    <span class="estrella" data-value="1">★</span>
                    <span class="estrella" data-value="2">★</span>
                    <span class="estrella" data-value="3">★</span>
                    <span class="estrella" data-value="4">★</span>
                    <span class="estrella" data-value="5">★</span>
                </div>
                <div class="calificacion-texto">
                    <span id="textoCalificacion">Selecciona una calificación</span>
                </div>
                <input type="hidden" id="valorCalificacion" value="0">
            </div>

            <div class="comentario-section">
                <label for="comentarioCalificacion">Comentario (opcional):</label>
                <textarea id="comentarioCalificacion" placeholder="Comparte tu experiencia con este servicio..."></textarea>
                <button type="button" class="btn-toggle-comentario" onclick="toggleComentario()">
                    <i class="fas fa-comment"></i> Agregar comentario
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="cerrarModalCalificacion()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarCalificacion()">Enviar Calificación</button>
            </div>
        </form>
    </div>
</div>

    <script>
// Detectar calificaciones pendientes al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si el usuario está logueado y es cliente (tipo 1)
    const userType = "{{ session.get('user_type', '') }}";
    const isLoggedIn = "{{ session.get('is_logged_in', False) }}" === "True";
    
    if (isLoggedIn && userType === '1') {
        verificarCalificacionesPendientes();
    }
});

function verificarCalificacionesPendientes() {
    fetch('/api/calificaciones_pendientes')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.calificaciones_pendientes.length > 0) {
                // Mostrar el primer trabajo/mentoría pendiente de calificar
                const primeraCalificacion = data.calificaciones_pendientes[0];
                mostrarModalCalificacion(primeraCalificacion);
            }
        })
        .catch(error => console.error('Error:', error));
}

function mostrarModalCalificacion(calificacion) {
    document.getElementById('tipoServicio').value = calificacion.tipo;
    document.getElementById('servicioId').value = calificacion.id;
    document.getElementById('profesionalId').value = calificacion.profesional_id;
    
    // Configurar título según el tipo
    const titulo = calificacion.tipo === 'trabajo' ? 'Calificar Trabajo' : 'Calificar Mentoría';
    document.querySelector('.modal-title').textContent = titulo;
    
    // Mostrar modal
    document.getElementById('modalCalificacion').style.display = 'flex';
}

// Función para enviar calificación
function enviarCalificacion() {
    const tipo = document.getElementById('tipoServicio').value;
    const servicioId = document.getElementById('servicioId').value;
    const profesionalId = document.getElementById('profesionalId').value;
    const calificacion = document.getElementById('valorCalificacion').value;
    const comentario = document.getElementById('comentarioCalificacion').value;

    if (calificacion === '0') {
        alert('Por favor selecciona una calificación');
        return;
    }

    const url = tipo === 'trabajo' ? '/calificar_trabajo/' : '/calificar_mentoria_desempleado/';
    
    fetch(url + servicioId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            calificacion: parseInt(calificacion),
            comentario: comentario,
            trabajadorId: profesionalId,
            mentorId: profesionalId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('¡Gracias por tu calificación!');
            cerrarModalCalificacion();
            // Verificar si hay más calificaciones pendientes
            verificarCalificacionesPendientes();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la calificación');
    });
}

function cerrarModalCalificacion() {
    document.getElementById('modalCalificacion').style.display = 'none';
    // Limpiar formulario
    document.getElementById('valorCalificacion').value = '0';
    document.getElementById('comentarioCalificacion').value = '';
    // Resetear estrellas
    document.querySelectorAll('.estrella').forEach(star => {
        star.classList.remove('active');
    });
    document.getElementById('textoCalificacion').textContent = 'Selecciona una calificación';
}

// Sistema de estrellas
document.querySelectorAll('.estrella').forEach(star => {
    star.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        document.getElementById('valorCalificacion').value = value;
        
        // Actualizar visualización de estrellas
        document.querySelectorAll('.estrella').forEach(s => {
            s.classList.remove('active');
            if (s.getAttribute('data-value') <= value) {
                s.classList.add('active');
            }
        });
        
        // Actualizar texto
        const textos = {
            '1': 'Muy malo',
            '2': 'Malo', 
            '3': 'Regular',
            '4': 'Bueno',
            '5': 'Excelente'
        };
        document.getElementById('textoCalificacion').textContent = textos[value];
    });
});

// Cerrar modal al hacer click fuera
document.getElementById('modalCalificacion').addEventListener('click', function(e) {
    if (e.target === this) cerrarModalCalificacion();
});

function toggleComentario() {
    const textarea = document.getElementById('comentarioCalificacion');
    const button = document.querySelector('.btn-toggle-comentario');
    
    if (textarea.style.display === 'none' || textarea.style.display === '') {
        textarea.style.display = 'block';
        button.innerHTML = '<i class="fas fa-times"></i> Ocultar comentario';
    } else {
        textarea.style.display = 'none';
        button.innerHTML = '<i class="fas fa-comment"></i> Agregar comentario';
    }
}

 document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado - inicializando botones flotantes');
        
        // Botón del Muro
        const muroButton = document.getElementById('muroButton');
        console.log('Botón muro encontrado:', muroButton);
        
        if (muroButton) {
            muroButton.addEventListener('click', function() {
                console.log('Clic en muro - redirigiendo...');
                window.location.href = '/muro_publicaciones';
            });
        }

        // Botón del Chat
        const chatButton = document.getElementById('chatButton');
        console.log('Botón chat encontrado:', chatButton);
        
        if (chatButton) {
            chatButton.addEventListener('click', function() {
                console.log('Clic en chat - redirigiendo...');
                window.location.href = '/chat_home';
            });
        }
    });
</script>
</body>
</html>