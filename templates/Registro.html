<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro - QuickFix</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>


    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      padding: 20px 0;
    }
    
    .contenedordelogin {
      max-width: 500px;
      margin: 20px auto;
      padding: 40px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      /* SCROLLABLE */
      max-height: 85vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #4a90e2 #f1f1f1;
    }

    /* Personalizar scrollbar */
    .contenedordelogin::-webkit-scrollbar {
      width: 8px;
    }

    .contenedordelogin::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .contenedordelogin::-webkit-scrollbar-thumb {
      background: #4a90e2;
      border-radius: 10px;
    }

    .contenedordelogin::-webkit-scrollbar-thumb:hover {
      background: #357abd;
    }

    /* Estilos adicionales para el formulario */
    .hidden {
      display: none;
    }
    
    .especializaciones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .especializacion-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .especializacion-item:hover {
      background: #e9ecef;
    }
    
    .especializacion-item.selected {
      background: #4a90e2;
      color: white;
    }
    
    .file-upload {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .file-upload:hover {
      border-color: #4a90e2;
    }
    
    .file-upload i {
      font-size: 24px;
      color: #666;
      margin-bottom: 10px;
    }



  </style>
</head>



<body>

    <!-- Modal para el mapa FUERA del formulario -->
  <div id="mapModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üó∫Ô∏è Seleccion√° tu ubicaci√≥n en el mapa</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="map-instructions">
          <i class="fas fa-info-circle"></i> Hac√© click en el mapa para seleccionar tu ubicaci√≥n exacta
        </div>
        <div class="map-container-large">
          <div id="map"></div>
        </div>
        <div class="map-controls">
          <div class="map-coordinates" id="coordinates-display">
            <strong>üìç Ubicaci√≥n seleccionada:</strong><br>
            Latitud: <span id="lat-display">-</span><br>
            Longitud: <span id="lng-display">-</span>
          </div>
          <button id="confirmLocation" class="btn-map-confirm" disabled>
            ‚úÖ Confirmar Ubicaci√≥n Seleccionada
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="background-lines">
    <div class="line line-1"></div>
    <div class="line line-2"></div>
    <div class="line line-3"></div>
    <div class="line line-4"></div>
  </div>

  <!-- SOLO UN CONTENEDOR -->
  <div class="contenedordelogin">
    <h2>Registro de Usuario</h2>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="/registrate" enctype="multipart/form-data" id="registroForm">
      <!-- Campos comunes para todos los usuarios -->
      <div class="cajita">
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" name="nombre" placeholder="Tu nombre" required>
      </div>

      <div class="cajita">
        <label for="apellido">Apellido</label>
        <input type="text" id="apellido" name="apellido" placeholder="Tu apellido" required>
      </div>

      <div class="cajita">
        <label for="mail">Email</label>
        <input type="email" id="mail" name="mail" placeholder="tu@email.com" required>
      </div>

      <div class="cajita">
        <label for="tel">Tel√©fono</label>
        <input type="tel" id="tel" name="tel" placeholder="Tu n√∫mero de tel√©fono" required>
      </div>

      <div class="cajita">
        <label for="birth">Fecha de Nacimiento</label>
        <input type="date" id="birth" name="birth" required>
      </div>

      <div class="cajita">
        <label for="contra">Contrase√±a</label>
        <input type="password" id="contra" name="contra" placeholder="Contrase√±a segura" required minlength="6">
      </div>

      <div class="cajita">
        <label for="confirmar_contra">Confirmar Contrase√±a</label>
        <input type="password" id="confirmar_contra" name="confirmar_contra" placeholder="Repet√≠ tu contrase√±a" required>
      </div>

      <!-- Selecci√≥n de rol -->
      <div class="cajita">
        <label>Tipo de usuario</label>
        <div class="opciones">
          <label><input type="radio" name="rol" value="cliente" checked /> Cliente</label>
          <label><input type="radio" name="rol" value="trabajador" /> Trabajador</label>
          <label><input type="radio" name="rol" value="desempleado" /> Desempleado</label>
        </div>
      </div>

      <!-- Campos espec√≠ficos por rol -->
      <div id="extra-fields">
        <!-- Campos para cliente -->
        <!-- Campos para cliente -->
<div id="cliente-fields">
  <div class="cajita">
    <label for="zona">Zona en la que viv√≠s</label>
    <input type="text" id="zona" name="zona" placeholder="Ej. Palermo, La Boca, etc.">
  </div>

  <!-- AGREGAR ESTO: Modal para el mapa DENTRO del formulario -->
  <!-- Modal para el mapa DENTRO del formulario -->

</div>

  <!-- Bot√≥n para abrir el mapa DENTRO del formulario -->
  <div class="cajita">
    <label>Ubicaci√≥n</label>
    <div class="location-selector">
      <button type="button" id="openMapBtn" class="btn-map-open">
        <i class="fas fa-map-marker-alt"></i> Seleccionar en el mapa
      </button>
      <div id="locationSummary" class="location-summary">
        <small>No se seleccion√≥ ubicaci√≥n</small>
      </div>
    </div>
    <!-- Campos ocultos para las coordenadas -->
    <input type="hidden" id="latitud" name="latitud">
    <input type="hidden" id="longitud" name="longitud">
  </div>
</div>

        <!-- Campos para trabajador -->
        <div id="trabajador-fields" class="hidden">
          <div class="cajita">
            <label>Especialidades</label>
            <div class="especializaciones-grid" id="especializaciones-container">
              <!-- Las especialidades se cargar√°n con JavaScript -->
            </div>
            <div class="cajita">
              <label for="otras_especialidades">Otras especialidades (separadas por coma)</label>
              <input type="text" id="otras_especialidades" name="otras_especialidades" placeholder="Ej. Instalador de persianas, etc.">
            </div>
          </div>
          
          <div class="cajita">
            <label for="ayudar_otros">
              <input type="checkbox" id="ayudar_otros" name="ayudar_otros" value="true">
              ¬øEst√°s dispuesto a ense√±arles a otros tus conocimientos en esta √°rea?
            </label>
          </div>
          
          <div class="cajita">
            <label>CV (PDF)</label>
            <div class="file-upload" onclick="document.getElementById('cv_trabajador').click()">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Hac√© clic para subir tu CV en PDF</p>
              <small id="cv-file-name"></small>
            </div>
            <input type="file" id="cv_trabajador" name="cv_trabajador" accept=".pdf" class="hidden">
          </div>
        </div>

        <!-- Campos para desempleado -->
        <div id="desempleado-fields" class="hidden">
          <div class="cajita">
            <label for="secundaria">
              <input type="checkbox" id="secundaria" name="secundaria" value="true">
              ¬øTerminaste el secundario?
            </label>
          </div>
          
          <div class="cajita">
            <label>CV (PDF)</label>
            <div class="file-upload" onclick="document.getElementById('cv_desempleado').click()">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Hac√© clic para subir tu CV en PDF</p>
              <small id="cv-file-name-desempleado"></small>
            </div>
            <input type="file" id="cv_desempleado" name="cv_desempleado" accept=".pdf" class="hidden">
          </div>
        </div>
      </div>

      <button type="submit" class="btn">Registrarse <i class="fas fa-arrow-right"></i></button>
    </form>

    <div class="footer">
      ¬øYa ten√©s cuenta? <a href="/login">Iniciar sesi√≥n</a>
    </div>
  </div>

  
  <script>
    // TODO EL C√ìDIGO JAVASCRIPT AQU√ç DENTRO
    // Variables para el mapa
    let map;
    let marcador = null;
    let coordenadasSeleccionadas = null;

    // Inicializar mapa
    function initMap() {
        const defaultCenter = { lat: -34.6037, lng: -58.3816 };
        
        map = new google.maps.Map(document.getElementById("map"), {
            center: defaultCenter,
            zoom: 14,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#f5f5f5" }]
                }
            ]
        });

        // Intentar geolocalizaci√≥n
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const ubicacionActual = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    };
                    map.setCenter(ubicacionActual);
                },
                () => {
                    console.log("Geolocalizaci√≥n no permitida.");
                }
            );
        }

        // Click en el mapa
        map.addListener("click", function(event) {
            const latLng = event.latLng;
            
            if (!marcador) {
                marcador = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    draggable: true
                });
            } else {
                marcador.setPosition(latLng);
            }

            coordenadasSeleccionadas = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };

            // Actualizar display
            document.getElementById('lat-display').textContent = coordenadasSeleccionadas.lat.toFixed(6);
            document.getElementById('lng-display').textContent = coordenadasSeleccionadas.lng.toFixed(6);
            document.getElementById('coordinates-display').style.display = 'block';
            document.getElementById('confirmLocation').disabled = false;
        });
    }

    // Modal functions
    function openMapModal() {
        document.getElementById('mapModal').classList.remove('hidden');
    }

    function closeMapModal() {
        document.getElementById('mapModal').classList.add('hidden');
    }

    function confirmLocation() {
    if (coordenadasSeleccionadas) {
        // Guardar en campos hidden
        document.getElementById('latitud').value = coordenadasSeleccionadas.lat;
        document.getElementById('longitud').value = coordenadasSeleccionadas.lng;
        
        // Actualizar resumen
        const summary = document.getElementById('locationSummary');
        summary.innerHTML = `
            <i class="fas fa-check-circle"></i> 
            üìç Ubicaci√≥n confirmada: ${coordenadasSeleccionadas.lat.toFixed(6)}, ${coordenadasSeleccionadas.lng.toFixed(6)}
        `;
        summary.classList.add('has-location');
        
        closeMapModal();
    }
}

    // Datos de especializaciones
    const especializaciones = {
        1: "Fontanero_Plomero",
        2: "Electricista", 
        3: "Gasista_matriculado",
        4: "Alba√±il",
        5: "Carpintero",
        6: "Pintor",
        7: "Herrero",
        8: "Techista_Impermeabilizador",
        9: "Cerrajero",
        10: "Instalador_de_aires_acondicionados",
        11: "Instalador_de_alarmas_camaras_de_seguridad",
        12: "Personal_de_limpieza",
        13: "Limpieza_de_tanques_de_agua",
        14: "Limpieza_de_vidrios_en_altura",
        15: "LavadoDeAlfombras_cortinas",
        16: "Fumigador",
        17: "Jardinero",
        18: "Podador_de_arboles",
        19: "Mantenimiento_de_piletas",
        20: "Paisajista",
        21: "Tecnico_de_electrodomesticos",
        22: "Tecnico_de_celulares",
        23: "TecnicoDeComputadoras_laptops",
        24: "TecnicoDeTelevisores_equiposelectronicos",
        25: "Tecnico_de_impresoras",
        26: "InstaladorDeRedes_WiFi"
    };

    // Mapeo para mostrar nombres amigables al usuario
    const nombresAmigables = {
        "Fontanero_Plomero": "Fontanero/Plomero",
        "Gasista_matriculado": "Gasista matriculado",
        "Techista_Impermeabilizador": "Techista/Impermeabilizador",
        "Instalador_de_aires_acondicionados": "Instalador de aires acondicionados",
        "Instalador_de_alarmas_camaras_de_seguridad": "Instalador de alarmas/c√°maras de seguridad",
        "Personal_de_limpieza": "Personal de limpieza",
        "Limpieza_de_tanques_de_agua": "Limpieza de tanques de agua",
        "Limpieza_de_vidrios_en_altura": "Limpieza de vidrios en altura",
        "LavadoDeAlfombras_cortinas": "Lavado de alfombras/cortinas",
        "Podador_de_arboles": "Podador de √°rboles",
        "Mantenimiento_de_piletas": "Mantenimiento de piletas",
        "Tecnico_de_electrodomesticos": "T√©cnico de electrodom√©sticos",
        "Tecnico_de_celulares": "T√©cnico de celulares",
        "TecnicoDeComputadoras_laptops": "T√©cnico de computadoras/laptops",
        "TecnicoDeTelevisores_equiposelectronicos": "T√©cnico de televisores/equipos electr√≥nicos",
        "Tecnico_de_impresoras": "T√©cnico de impresoras",
        "InstaladorDeRedes_WiFi": "Instalador de redes/WiFi"
    };

    // Inicializar especializaciones
    function inicializarEspecializaciones() {
        const container = document.getElementById('especializaciones-container');
        container.innerHTML = '';
        
        for (const [key, value] of Object.entries(especializaciones)) {
            const div = document.createElement('div');
            div.className = 'especializacion-item';
            
            // Mostrar nombre amigable al usuario, pero guardar el valor t√©cnico
            const nombreMostrar = nombresAmigables[value] || value;
            
            div.innerHTML = `
                <input type="checkbox" id="esp_${key}" name="especialidades" value="${value}" class="hidden">
                <span>${nombreMostrar}</span>
            `;
            div.addEventListener('click', function() {
                const checkbox = this.querySelector('input');
                checkbox.checked = !checkbox.checked;
                this.classList.toggle('selected', checkbox.checked);
            });
            container.appendChild(div);
        }
    }

    // Mostrar/ocultar campos seg√∫n el rol
    function actualizarCamposPorRol() {
        const rol = document.querySelector('input[name="rol"]:checked').value;
        
        // Ocultar todos los campos espec√≠ficos
        document.getElementById('cliente-fields').classList.add('hidden');
        document.getElementById('trabajador-fields').classList.add('hidden');
        document.getElementById('desempleado-fields').classList.add('hidden');
        
        // Mostrar campos del rol seleccionado
        document.getElementById(`${rol}-fields`).classList.remove('hidden');
    }

    // Manejar subida de archivos
    document.getElementById('cv_trabajador')?.addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name || 'Ning√∫n archivo seleccionado';
        document.getElementById('cv-file-name').textContent = fileName;
    });

    document.getElementById('cv_desempleado')?.addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name || 'Ning√∫n archivo seleccionado';
        document.getElementById('cv-file-name-desempleado').textContent = fileName;
    });

    // Validaci√≥n de formulario
    document.getElementById('registroForm').addEventListener('submit', function(e) {
        const password = document.getElementById('contra').value;
        const confirmPassword = document.getElementById('confirmar_contra').value;
        
        if (password !== confirmPassword) {
            e.preventDefault();
            alert('‚ùå Las contrase√±as no coinciden');
            return false;
        }
        
        // Validar campos requeridos seg√∫n el rol
        const rol = document.querySelector('input[name="rol"]:checked').value;
        
        if (rol === 'trabajador') {
            const especialidadesSeleccionadas = document.querySelectorAll('input[name="especialidades"]:checked');
            if (especialidadesSeleccionadas.length === 0) {
                e.preventDefault();
                alert('‚ùå Por favor selecciona al menos una especialidad');
                return false;
            }
            
            const cv = document.getElementById('cv_trabajador').files[0];
            if (!cv) {
                e.preventDefault();
                alert('‚ùå Por favor sube tu CV');
                return false;
            }
        }
        
        if (rol === 'desempleado') {
            const cv = document.getElementById('cv_desempleado').files[0];
            if (!cv) {
                e.preventDefault();
                alert('‚ùå Por favor sube tu CV');
                return false;
            }
        }
        
        return true;
    });

    // Event listeners
    document.querySelectorAll('input[name="rol"]').forEach(radio => {
        radio.addEventListener('change', actualizarCamposPorRol);
    });

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        inicializarEspecializaciones();
        actualizarCamposPorRol();
        
        // Event listeners del mapa
        document.getElementById('openMapBtn')?.addEventListener('click', openMapModal);
        document.querySelector('.close')?.addEventListener('click', closeMapModal);
        document.getElementById('confirmLocation')?.addEventListener('click', confirmLocation);

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('mapModal');
            if (event.target === modal) {
                closeMapModal();
            }
        });
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQcLrAtTG5MLlmC_qQNv_I7Yf8FYFJXI8&callback=initMap">
  </script>

</body>
</html>