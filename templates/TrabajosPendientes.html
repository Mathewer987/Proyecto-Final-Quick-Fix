<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trabajos Pendientes - QuickFix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='TrabajosPendientes.css') }}">
</head>
<body>
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
        <div class="line line-4"></div>
    </div>

    <!-- Modal de cancelaci칩n -->
    <div class="modal-overlay" id="modalCancelacion">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cancelar Trabajo</h3>
                <button class="close-modal" onclick="cerrarModalCancelacion()">&times;</button>
            </div>
            <form id="formCancelacion">
                <input type="hidden" id="trabajoIdCancelacion" value="">
                <div class="form-group">
                    <label for="motivoCancelacion">Motivo de cancelaci칩n:</label>
                    <textarea id="motivoCancelacion" placeholder="Explica brevemente por qu칠 cancelas este trabajo..." required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="cerrarModalCancelacion()">Volver</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">Confirmar Cancelaci칩n</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">Quick<span>Fix</span></div>
                <a href="{{ url_for('home') }}" class="back-button"><i class="fas fa-arrow-left"></i> Volver al Inicio</a>
            </div>
            <nav class="nav">
                <a href="{{ url_for('home') }}" class="nav-item">Inicio</a>
                <a href="/trabajos" class="nav-item">Solicitudes</a>
                <a href="/trabajos_pendientes" class="nav-item active">Trabajos Pendientes</a>
                <a href="#" class="nav-item">Historial</a>
                <a class="nav-item" href="{{ url_for('logout') }}"><i class="fas fa-user"></i> Cerrar Sesi칩n</a>
            </nav>
        </header>

                <main class="main-content">
            <div class="page-header">
                <h1>Trabajos Pendientes</h1>
                <p>Gestiona tus contrataciones de clientes y mentor칤as activas.</p>
            </div>

            <!-- SECCI칍N CONTRATACIONES DE CLIENTES -->
            <div class="seccion-trabajos">
                <div class="seccion-header">
                    <h2>Contrataciones de Clientes</h2>
                    <span class="contador-badge">{{ trabajos_contrataciones|length }} pendientes</span>
                </div>
                
                {% if trabajos_contrataciones %}
                <div class="trabajos-grid">
                    {% for trabajo in trabajos_contrataciones %}
                    <div class="trabajo-card" data-tipo="contratacion">
                        <div class="tipo-badge tipo-contratacion">游눯 Contrataci칩n</div>
                        
                        <div class="trabajo-header">
                            <h3>{{ trabajo.especializacion }}</h3>
                            <span class="estado-badge estado-pendiente">Pendiente</span>
                        </div>

                        <div class="trabajo-info">
                            <div class="info-group">
                                <h4>Informaci칩n del Cliente</h4>
                                <div class="info-item">
                                    <span class="info-label">Cliente:</span>
                                    <span class="info-value">{{ trabajo.cliente_nombre }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Detalles del Trabajo</h4>
                                <div class="info-item">
                                    <span class="info-label">Fecha acordada:</span>
                                    <span class="info-value">{{ trabajo.fecha_trabajo_propuesta }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ubicaci칩n:</span>
                                    <span class="info-value">{{ trabajo.ubicacion }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">M칠todo de pago:</span>
                                    <span class="info-value">{{ trabajo.metodo_pago }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Especificaciones</h4>
                                <p class="especificaciones">{{ trabajo.especificaciones }}</p>
                            </div>

                            {% if trabajo.especificaciones_trabajador %}
                            <div class="info-group">
                                <h4>Tus comentarios anteriores</h4>
                                <p class="comentarios-trabajador">{{ trabajo.especificaciones_trabajador }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Botones de acci칩n -->
                        <div class="trabajo-actions">
                            <button class="btn btn-complete" onclick="finalizarTrabajo('{{ trabajo.id }}', 'contratacion')">
                                <i class="fas fa-check-circle"></i> Finalizado
                            </button>
                            <button class="btn btn-contact" onclick="contactarCliente('{{ trabajo.cliente_id }}')">
                                <i class="fas fa-envelope"></i> Contactar Cliente
                            </button>
                            <button class="btn btn-cancel-job" onclick="abrirModalCancelacion('{{ trabajo.id }}', 'contratacion')">
                                <i class="fas fa-times-circle"></i> Cancelar Trabajo
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-section">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No tienes contrataciones pendientes</h3>
                    <p>Cuando aceptes trabajos de clientes, aparecer치n aqu칤.</p>
                </div>
                {% endif %}
            </div>

            <!-- SECCI칍N MENTOR칈AS -->
            <div class="seccion-trabajos">
                <div class="seccion-header">
                    <h2>Mentor칤as Activas</h2>
                    <span class="contador-badge">{{ trabajos_mentorias|length }} activas</span>
                </div>
                
                {% if trabajos_mentorias %}
                <div class="trabajos-grid">
                    {% for mentoria in trabajos_mentorias %}
                    <div class="trabajo-card" data-tipo="mentoria">
                        
                        <div class="trabajo-header">
                            <h3>Mentor칤a - {{ mentoria.area_interes }}</h3>
                            <span class="estado-badge estado-mentoria">En Progreso</span>
                        </div>

                        <div class="trabajo-info">
                            <div class="info-group">
                                <h4>Informaci칩n del Aprendiz</h4>
                                <div class="info-item">
                                    <span class="info-label">Aprendiz:</span>
                                    <span class="info-value">{{ mentoria.desempleado_nombre }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Detalles de la Mentor칤a</h4>
                                <div class="info-item">
                                    <span class="info-label">츼rea de inter칠s:</span>
                                    <span class="info-value">{{ mentoria.area_interes }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Disponibilidad:</span>
                                    <span class="info-value">{{ mentoria.disponibilidad }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Iniciada el:</span>
                                    <span class="info-value">{{ mentoria.fecha_solicitud.strftime('%d/%m/%Y') }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Objetivos del Aprendiz</h4>
                                <p class="especificaciones">{{ mentoria.objetivo }}</p>
                            </div>
                        </div>

                        <!-- Botones de acci칩n para mentor칤as -->
                        <div class="trabajo-actions">
                            <button class="btn btn-complete" onclick="finalizarMentoriaTrabajador('{{ mentoria.id }}')">
                                <i class="fas fa-graduation-cap"></i> Mentor칤a Completa
                            </button>
                            <button class="btn btn-contact" onclick="contactarAprendiz('{{ mentoria.desempleado_id }}')">
                                <i class="fas fa-comments"></i> Contactar Aprendiz
                            </button>
                            <button class="btn btn-cancel-job" onclick="abrirModalCancelacionMentoria('{{ mentoria.id }}')">
                                <i class="fas fa-times-circle"></i> Cancelar Mentor칤a
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-section">
                    <i class="fas fa-users"></i>
                    <h3>No tienes mentor칤as activas</h3>
                    <p>Cuando aceptes solicitudes de mentor칤a, aparecer치n aqu칤.</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <script>

        function finalizarMentoriaTrabajador(mentoriaId) {
    if (confirm('쮼st치s seguro de que deseas marcar esta mentor칤a como completada?\n\nEl aprendiz recibir치 una notificaci칩n.')) {
        fetch(`/finalizar_mentoria/${mentoriaId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Mentor칤a marcada como completada. El aprendiz puede verla en sus capacitaciones completadas.');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    }
}
        function finalizarTrabajo(trabajoId) {
            if (confirm('쮼st치s seguro de que deseas marcar este trabajo como finalizado?')) {
                fetch(`/finalizar_trabajo/${trabajoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Trabajo marcado como finalizado con 칠xito');
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al procesar la solicitud');
                });
            }
        }

        function contactarCliente(clienteId) {
            alert('Funcionalidad de contacto con el cliente en desarrollo para ID: ' + clienteId);
        }

        // Modal cancelaci칩n
        let trabajoCancelacionId = '';

        function abrirModalCancelacion(trabajoId) {
            trabajoCancelacionId = trabajoId;
            document.getElementById('trabajoIdCancelacion').value = trabajoId;
            document.getElementById('motivoCancelacion').value = '';
            document.getElementById('modalCancelacion').style.display = 'flex';
        }

        function cerrarModalCancelacion() {
            document.getElementById('modalCancelacion').style.display = 'none';
            trabajoCancelacionId = '';
        }

        function confirmarCancelacion() {
            const motivo = document.getElementById('motivoCancelacion').value.trim();
            if (!motivo) { alert('Por favor, ingresa el motivo de la cancelaci칩n.'); return; }
            if (confirm('쮼st치s seguro de cancelar este trabajo?')) {
                fetch(`/cancelar_trabajo/${trabajoCancelacionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motivo: motivo })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Trabajo cancelado correctamente');
                        cerrarModalCancelacion();
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al procesar la solicitud');
                });
            }
        }

        // Cerrar modal al hacer click fuera del contenido
        document.getElementById('modalCancelacion').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalCancelacion();
        });

        // Evitar submit con Enter dentro del textarea
        document.getElementById('formCancelacion').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') e.preventDefault();
        });
    </script>
</body>
</html>
