<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con {{ otro_usuario_nombre }} - Quick Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === ESTILOS GENERALES DEL CHAT === */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: #f7fafc;
  color: #2d3748;
}

/* === CONTENEDOR PRINCIPAL === */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: #f7fafc;
}

/* === ENCABEZADO SUPERIOR DEL CHAT === */
.chat-header {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  background: #2d3748;
  color: white;
  border-bottom: 2px solid #1a202c;
}

.chat-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

/* === ZONA DE CONTACTO (DATOS DEL OTRO USUARIO) === */
.contact-header {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  background: white;
  border-bottom: 1px solid #e2e8f0;
}

.contact-details {
  display: flex;
  flex-direction: column;
  margin-left: 12px;
}

/* === AVATAR (C√çRCULO CON INICIAL) === */
.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 20px;
  text-transform: uppercase;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
  flex-shrink: 0;
}

/* COLORES DE AVATARES SEG√öN EL TIPO DE USUARIO */
.avatar.cliente {
  background: #4299e1 !important; /* Azul */
}

.avatar.trabajador {
  background: #48bb78 !important; /* Verde */
  box-shadow: 0 0 8px #48bb78cc; /* Resalta el verde */
}

.avatar.desempleado {
  background: #ed8936 !important; /* Naranja */
}

/* === ETIQUETA DE TIPO DE USUARIO (SUBMARQUITA) === */
.user-type {
  margin-top: 3px;
  font-size: 13px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 8px;
  display: inline-block;
  color: white;
  text-transform: capitalize;
  align-self: flex-start;
}

/* Colores seg√∫n tipo */
.user-type.cliente {
  background: #4299e1 !important; /* Azul */
}

.user-type.trabajador {
  background: #48bb78 !important; /* Verde */
  box-shadow: 0 0 4px #48bb78aa;
}

.user-type.desempleado {
  background: #ed8936 !important; /* Naranja */
}

/* === MENSAJES DEL CHAT === */
.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  background: #f7fafc;
}

.chat-message {
  max-width: 70%;
  padding: 10px 15px;
  margin: 8px 0;
  border-radius: 15px;
  word-wrap: break-word;
  line-height: 1.4;
}

/* Mensajes enviados (usuario actual) */
.chat-message.sent {
  align-self: flex-end;
  background: #3182ce;
  color: white;
  border-bottom-right-radius: 0;
}

/* Mensajes recibidos (otro usuario) */
.chat-message.received {
  align-self: flex-start;
  background: #edf2f7;
  color: #2d3748;
  border-bottom-left-radius: 0;
}

/* === INPUT DEL MENSAJE === */
.chat-input {
  display: flex;
  align-items: center;
  border-top: 1px solid #e2e8f0;
  background: white;
  padding: 10px;
}

.chat-input input {
  flex: 1;
  border: none;
  outline: none;
  padding: 10px;
  font-size: 15px;
  border-radius: 8px;
  background: #f1f5f9;
  color: #2d3748;
}

.chat-input button {
  background: #3182ce;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  margin-left: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s ease;
}

.chat-input button:hover {
  background: #2b6cb0;
}

/* === SCROLLBAR PERSONALIZADA === */
.chat-body::-webkit-scrollbar {
  width: 6px;
}

.chat-body::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

/* === OPCIONAL: EFECTO AL PASAR SOBRE EL HEADER DE CONTACTO === */
.contact-header:hover {
  background: #f9fafb;
  transition: background 0.2s ease;
}

    </style>
</head>
<body>
    <div class="chat-container">
        {% if error %}
            <div class="error-message">
                <h2>‚ùå Error</h2>
                <p>{{ error }}</p>
                <a href="/chat_home">Volver al inicio</a>
            </div>
        {% else %}
            <!-- Header -->
            <div class="chat-header">
                <a href="/chat_home" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div class="contact-info">
                    <div class="avatar {{ otro_usuario_tipo }}">
                        {{ otro_usuario_nombre[0] if otro_usuario_nombre else 'U' }}
                    </div>
                    <div class="contact-details">
                        <h2>{{ otro_usuario_nombre or 'Usuario' }}</h2>
                        <span class="user-type {{ otro_usuario_tipo|lower }}">
    {{ otro_usuario_tipo }}
</span>
                        {% if otro_usuario_email %}
                        <div class="user-email">{{ otro_usuario_email }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- √Årea de mensajes -->
            <div class="messages-container" id="messagesContainer">
                {% if mensajes %}
                    {% for mensaje in mensajes %}
                        <div class="message {% if mensaje.emisor_id == user_id %}sent{% else %}received{% endif %}">
                            <div class="message-content">
                                <p>{{ mensaje.contenido }}</p>
                                <span class="message-time">
                                    {{ mensaje.timestamp_str }}
                                    {% if mensaje.emisor_id == user_id %}
                                        <span class="message-status {% if mensaje.leido %}read{% else %}delivered{% endif %}">
                                            <i class="fas fa-{% if mensaje.leido %}check-double{% else %}check{% endif %}"></i>
                                        </span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <!-- Conversaci√≥n vac√≠a -->
                    <div class="empty-conversation">
                        <i class="fas fa-comments"></i>
                        <h3>Conversaci√≥n vac√≠a</h3>
                        <p>Env√≠a el primer mensaje para comenzar la conversaci√≥n con {{ otro_usuario_nombre }}</p>
                    </div>
                {% endif %}
            </div>

            <!-- Input de mensaje -->
            <div class="message-input-container">
                <form id="messageForm">
                    <input type="hidden" id="conversacionId" value="{{ conversacion_id }}">
                    <input type="hidden" id="userId" value="{{ user_id }}">
                    <div class="input-group">
                        <textarea 
                            id="messageInput" 
                            placeholder="Escribe tu mensaje..." 
                            maxlength="1000"
                            autocomplete="off"
                            rows="1"
                        ></textarea>
                        <button type="submit" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN INICIAL
        // =============================================
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const conversacionId = document.getElementById('conversacionId').value;
        const userId = document.getElementById('userId').value;

        // =============================================
        // FUNCIONES PRINCIPALES
        // =============================================

        // Scroll al final de los mensajes
        function scrollToBottom() {
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Auto-ajustar altura del textarea
        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        }

        // Formatear hora actual
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        // Remover estado de conversaci√≥n vac√≠a
        function removeEmptyState() {
            const emptyState = messagesContainer.querySelector('.empty-conversation');
            if (emptyState) {
                emptyState.remove();
                return true;
            }
            return false;
        }

        // Crear elemento de mensaje optimista
        function createMessageElement(contenido, isSent = true, timestamp = null) {
            const messageId = 'temp_' + Date.now();
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            messageElement.id = messageId;
            
            const time = timestamp || getCurrentTime();
            const statusHtml = isSent ? 
                `<span class="message-status delivered">
                    <i class="fas fa-check"></i>
                </span>` : '';

            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${contenido}</p>
                    <span class="message-time">
                        ${time} ${statusHtml}
                    </span>
                </div>
            `;

            return messageElement;
        }

        // Mostrar mensaje de error
        function showErrorMessage(messageElement, error) {
            messageElement.querySelector('.message-content').innerHTML = `
                <p style="color: #e53e3e; font-style: italic;">
                    ‚ùå ${error}
                </p>
            `;
        }

        // =============================================
        // ENV√çO DE MENSAJES
        // =============================================

        async function enviarMensaje(contenido) {
            if (!contenido.trim()) return null;

            // Preparar la interfaz
            removeEmptyState();
            const newMessage = createMessageElement(contenido, true, 'Enviando...');
            messagesContainer.appendChild(newMessage);
            scrollToBottom();

            try {
                const response = await fetch('/api/enviar_mensaje', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        conversacion_id: conversacionId, 
                        contenido: contenido.trim()
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    // Actualizar mensaje con timestamp real
                    const time = result.timestamp || getCurrentTime();
                    newMessage.querySelector('.message-time').innerHTML = 
                        `${time} 
                         <span class="message-status delivered">
                             <i class="fas fa-check"></i>
                         </span>`;
                    
                    return newMessage;
                } else {
                    showErrorMessage(newMessage, result.message || 'Error desconocido');
                    return null;
                }
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                showErrorMessage(newMessage, 'Error de conexi√≥n. Intenta nuevamente.');
                return null;
            }
        }

        // =============================================
        // MARCAR MENSAJES COMO LE√çDOS
        // =============================================

        async function marcarMensajesComoLeidos() {
            try {
                const response = await fetch('/api/marcar_leidos', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        conversacion_id: conversacionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ ${result.mensajes_actualizados} mensajes marcados como le√≠dos`);
                } else {
                    console.error('‚ùå Error marcando mensajes como le√≠dos:', result.message);
                }
            } catch (error) {
                console.error('‚ùå Error en marcarMensajesComoLeidos:', error);
            }
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================

        // Env√≠o del formulario
        messageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const contenido = messageInput.value.trim();
            
            if (!contenido) return;

            // Deshabilitar temporalmente el env√≠o
            sendButton.disabled = true;
            messageInput.disabled = true;

            await enviarMensaje(contenido);
            
            // Limpiar y re-habilitar
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.disabled = false;
            sendButton.disabled = false;
            
            // Re-enfocar el input
            messageInput.focus();
        });

        // Auto-resize del textarea
        messageInput.addEventListener('input', autoResizeTextarea);

        // Tecla Enter para enviar (sin Shift)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit'));
            }
        });

        // Prevenir env√≠o con Enter en input vac√≠o
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !this.value.trim()) {
                e.preventDefault();
            }
        });

        // =============================================
        // INICIALIZACI√ìN
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando chat...');
            
            // Scroll al final
            scrollToBottom();
            
            // Enfocar el input
            messageInput.focus();
            
            // Marcar mensajes como le√≠dos al cargar
            marcarMensajesComoLeidos();
            
            // Auto-recargar para nuevos mensajes cada 8 segundos
            const reloadInterval = setInterval(() => {
                console.log('üîÑ Recargando conversaci√≥n...');
                window.location.reload();
            }, 8000);

            // Limpiar intervalo al salir de la p√°gina
            window.addEventListener('beforeunload', function() {
                clearInterval(reloadInterval);
            });

            // Debug info
            console.log('üí¨ Chat configurado:');
            console.log('- Conversaci√≥n ID:', conversacionId);
            console.log('- Usuario ID:', userId);
            console.log('- Auto-reload: cada 8 segundos');
        });

        // =============================================
        // MANEJO DE ERRORES GLOBALES
        // =============================================

        window.addEventListener('error', function(e) {
            console.error('‚ùå Error global:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Promise rechazada:', e.reason);
        });

    </script>
</body>
</html>