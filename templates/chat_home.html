<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Quick Fix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root {
    --primary-color: #2563eb;
    --secondary-color: #3b82f6;
    --accent-color: #2563eb;
    --light-color: #f8fafc;
    --dark-color: #1e293b;
    --text-color: #334155;
    --text-light: #64748b;
    --white: #ffffff;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Poppins', sans-serif; 
    background: var(--light-color);
    height: 100vh; display: flex; justify-content: center; align-items: center;
    padding: 20px;
    color: var(--text-color);
    position: relative;
    overflow: hidden;
}

.background-lines {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
}

.line {
    position: absolute;
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.1) 0%, rgba(37, 99, 235, 0.4) 50%, rgba(37, 99, 235, 0.1) 100%);
    border-radius: 20px;
    transform-origin: left center;
    animation: float 15s infinite linear;
}

.line-1 {
    width: 150%;
    height: 2px;
    top: 20%;
    left: -50%;
    transform: rotate(15deg);
    animation-delay: 0s;
}

.line-2 {
    width: 120%;
    height: 1px;
    top: 40%;
    left: -30%;
    transform: rotate(-10deg);
    animation-delay: 2s;
}

.line-3 {
    width: 180%;
    height: 3px;
    top: 65%;
    left: -80%;
    transform: rotate(5deg);
    animation-delay: 4s;
}

.line-4 {
    width: 200%;
    height: 1.5px;
    bottom: 15%;
    left: -100%;
    transform: rotate(-15deg);
    animation-delay: 6s;
}

@keyframes float {
    0% { transform: translateX(0) rotate(15deg); }
    100% { transform: translateX(100vw) rotate(15deg); }
}

/* Contenedor principal */
.whatsapp-container {
    width: 100%; max-width: 1400px; height: 95vh; 
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px; 
    box-shadow: var(--shadow);
    display: flex; overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
}

/* Panel izquierdo - Lista de chats */
.chats-panel {
    width: 30%; min-width: 300px; background: var(--white);
    border-right: 1px solid #e2e8f0; display: flex; flex-direction: column;
    transition: all 0.3s ease;
}

/* Panel derecho - Chat activo */
.chat-panel {
    flex: 1; background: #f7fafc; display: flex; flex-direction: column;
    position: relative;
}

/* Estado cuando no hay chat seleccionado */
.no-chat-selected {
    flex: 1; display: flex; flex-direction: column; justify-content: center;
    align-items: center; 
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    color: var(--text-light);
    text-align: center; padding: 40px;
}
.no-chat-selected i { 
    font-size: 5rem; margin-bottom: 30px; opacity: 0.3; 
    color: var(--primary-color);
}
.no-chat-selected h1 { 
    font-size: 2.5rem; margin-bottom: 15px; color: var(--dark-color); 
    font-weight: 700;
}
.no-chat-selected p { 
    font-size: 1.1rem; max-width: 400px; line-height: 1.6; 
    color: var(--text-light);
}

/* Header del panel de chats - Estilo ID√âNTICO a tu Home */
.chats-header {
    background: var(--white); padding: 20px; border-bottom: 1px solid #e2e8f0;
    display: flex; align-items: center; justify-content: space-between;
}

/* Bot√≥n Home - Mismo estilo que tus botones */
.home-btn { 
    color: var(--text-color); text-decoration: none; font-size: 1.2rem; 
    padding: 10px; border-radius: 50%; transition: all 0.3s ease;
    display: flex; align-items: center; justify-content: center;
    background: var(--light-color);
}
.home-btn:hover { 
    background: var(--primary-color); 
    color: white;
    transform: scale(1.1);
}

.user-avatar {
    width: 50px; height: 50px; border-radius: 50%; 
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 600; font-size: 18px; cursor: pointer;
}
.chats-actions {
    display: flex; gap: 12px;
}
.chat-action-btn {
    background: var(--light-color); border: none; color: var(--primary-color); 
    font-size: 16px; cursor: pointer; padding: 10px; border-radius: 50%; 
    transition: all 0.3s ease;
}
.chat-action-btn:hover { 
    background: var(--primary-color); 
    color: white;
    transform: scale(1.1);
}

/* Barra de b√∫squeda - Estilo ID√âNTICO a tu Home */
.search-container {
    padding: 20px; background: var(--white); border-bottom: 1px solid #e2e8f0;
}
.search-box {
    background: var(--light-color); border-radius: 25px; padding: 12px 20px;
    display: flex; align-items: center; gap: 10px;
    transition: all 0.3s ease;
}
.search-box:focus-within {
    box-shadow: 0 0 0 2px var(--primary-color);
}
.search-box i { color: var(--text-light); font-size: 14px; }
.search-input {
    border: none; outline: none; background: none; flex: 1;
    font-family: inherit; font-size: 14px; color: var(--text-color);
}
.search-input::placeholder { color: var(--text-light); }

/* Lista de chats */
.chats-list {
    flex: 1; overflow-y: auto; background: var(--white);
}

/* Items de chat - Estilo consistente con tu tema */
.chat-item {
    display: flex; padding: 20px; cursor: pointer; gap: 15px;
    border-bottom: 1px solid #f1f5f9; transition: all 0.3s ease;
}
.chat-item:hover { 
    background: #f8fafc; 
    transform: translateX(5px);
}
.chat-item.active { 
    background: #f0f9ff; 
    border-left: 4px solid var(--primary-color);
}
.chat-avatar {
    width: 55px; height: 55px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 600; font-size: 18px; flex-shrink: 0;
}

/* CORRECCI√ìN: Estilos mejorados para avatares */
.avatar.cliente { 
    background: linear-gradient(135deg, #4299e1, #3182ce) !important; 
}
.avatar.trabajador { 
    background: linear-gradient(135deg, #48bb78, #38a169) !important; 
}
.avatar.desempleado { 
    background: linear-gradient(135deg, #ed8936, #dd6b20) !important; 
}

/* Estilos de respaldo para trabajador */
.chat-avatar.avatar.trabajador,
.chat-item .avatar.trabajador {
    background: linear-gradient(135deg, #48bb78, #38a169) !important;
}

.chat-info {
    flex: 1; min-width: 0;
}
.chat-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
}
.chat-name {
    font-weight: 600; color: var(--dark-color); font-size: 16px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.chat-time {
    font-size: 12px; color: var(--text-light); flex-shrink: 0;
    font-weight: 500;
}
.chat-preview {
    display: flex; justify-content: space-between; align-items: center;
}
.chat-message {
    font-size: 14px; color: var(--text-light); white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; flex: 1;
}
.chat-badge {
    background: var(--primary-color); color: white; border-radius: 50%;
    width: 22px; height: 22px; font-size: 11px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-left: 8px; font-weight: 600;
}

/* Estado vac√≠o */
.chats-empty {
    text-align: center; padding: 60px 20px; color: var(--text-light);
    flex: 1; display: flex; flex-direction: column; justify-content: center;
    align-items: center;
}
.chats-empty i { 
    font-size: 4rem; margin-bottom: 20px; opacity: 0.3; 
    color: var(--primary-color);
}
.chats-empty h3 { 
    font-size: 1.3rem; margin-bottom: 10px; color: var(--dark-color); 
}
.chats-empty p { 
    font-size: 0.9rem; max-width: 250px; line-height: 1.5; 
}

/* ===== ESTILOS DEL CHAT ACTIVO ===== */

/* Header del chat */
.chat-header-active {
    background: var(--white); padding: 20px; border-bottom: 1px solid #e2e8f0;
    display: flex; align-items: center; gap: 15px;
}
.back-btn { 
    color: var(--text-color); text-decoration: none; font-size: 1.2rem; 
    padding: 10px; border-radius: 50%; transition: all 0.3s ease;
    display: none; cursor: pointer; background: var(--light-color);
}
.back-btn:hover { 
    background: var(--primary-color); 
    color: white;
}
.contact-info { display: flex; align-items: center; gap: 15px; flex: 1; }
.contact-details h2 { 
    font-size: 1.2rem; margin-bottom: 4px; color: var(--dark-color); 
    font-weight: 600;
}

/* CORRECCI√ìN: Estilos mejorados para tipos de usuario */
.user-type {
    font-size: 0.75rem; padding: 4px 12px; border-radius: 12px; 
    color: white; display: inline-block; font-weight: 500;
}
.user-type.cliente { 
    background: linear-gradient(135deg, #4299e1, #3182ce) !important; 
}
.user-type.trabajador { 
    background: linear-gradient(135deg, #48bb78, #38a169) !important; 
}
.user-type.desempleado { 
    background: linear-gradient(135deg, #ed8936, #dd6b20) !important; 
}

/* Estilos de respaldo para trabajador en user-type */
.contact-details .user-type.trabajador,
.chat-header-active .user-type.trabajador {
    background: linear-gradient(135deg, #48bb78, #38a169) !important;
    color: white !important;
}

.user-email { 
    font-size: 0.8rem; margin-top: 2px; color: var(--text-light); 
}

/* √Årea de mensajes */
.messages-container {
    flex: 1; padding: 20px; overflow-y: auto; 
    background: #f7fafc;
    display: flex; flex-direction: column; gap: 15px;
}

/* Mensajes - TUS mensajes con el azul exacto de tu p√°gina */
.message { display: flex; max-width: 70%; animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}
.message.sent { align-self: flex-end; }
.message.received { align-self: flex-start; }
.message-content {
    padding: 12px 16px; border-radius: 18px; position: relative;
    box-shadow: var(--shadow);
}
.message.sent .message-content {
    background: #2563eb;  /* TU azul exacto */
    color: white; 
    border-bottom-right-radius: 5px;
}
.message.received .message-content {
    background: white; 
    color: var(--dark-color); 
    border: 1px solid #e2e8f0;
    border-bottom-left-radius: 5px;
}
.message-time {
    font-size: 0.7rem; opacity: 0.7; margin-top: 5px; display: block;
    text-align: right; color: rgba(255,255,255,0.8);
}
.message.received .message-time { 
    text-align: left; color: var(--text-light);
}

/* Estado de mensaje enviado */
.message-status { 
    font-size: 0.6rem; margin-left: 5px; opacity: 0.7; 
    display: inline-flex; align-items: center; gap: 2px;
}
.message-status.sent i { color: #a0aec0; }
.message-status.delivered i { color: rgba(255,255,255,0.8); }
.message-status.read i { color: #48bb78; }

/* Input de mensaje - Estilo ID√âNTICO a tus formularios */
.message-input-container {
    border-top: 1px solid #e2e8f0; background: var(--white); padding: 20px;
}
.input-group { display: flex; gap: 12px; align-items: flex-end; }
#messageInput {
    flex: 1; padding: 12px 20px; border: 1px solid #e2e8f0; border-radius: 25px;
    font-family: inherit; font-size: 14px; outline: none;
    transition: all 0.3s; resize: none; min-height: 50px;
    max-height: 120px; background: var(--light-color);
}
#messageInput:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
}
#sendButton {
    background: #2563eb;  /* TU azul exacto */
    border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; 
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s; color: white; flex-shrink: 0;
}
#sendButton:hover { 
    background: #1d4ed8;  /* Azul m√°s oscuro al hover */
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}
#sendButton:active { transform: translateY(0); }
#sendButton:disabled {
    background: #a0aec0; cursor: not-allowed; transform: none;
}

/* Scrollbar personalizado */
.chats-list::-webkit-scrollbar,
.messages-container::-webkit-scrollbar { width: 6px; }
.chats-list::-webkit-scrollbar-track,
.messages-container::-webkit-scrollbar-track { background: #f1f1f1; }
.chats-list::-webkit-scrollbar-thumb,
.messages-container::-webkit-scrollbar-thumb { 
    background: #cbd5e0; border-radius: 3px; 
}
.chats-list::-webkit-scrollbar-thumb:hover,
.messages-container::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

/* Responsive */
@media (max-width: 768px) {
    body { padding: 10px; }
    .whatsapp-container { 
        height: 95vh; border-radius: 12px; 
        max-width: 100%; position: relative;
    }
    .chats-panel {
        width: 100%; position: absolute; top: 0; left: 0; bottom: 0;
        z-index: 10;
    }
    .chats-panel.hidden { transform: translateX(-100%); }
    .chat-panel { width: 100%; }
    .back-btn { display: block; }
    .no-chat-selected { display: none; }
    
    .chats-header { padding: 15px; }
    .search-container { padding: 15px; }
    .chat-item { padding: 15px; }
    .message { max-width: 85%; }
    .message-input-container { padding: 15px; }
}

/* Animaci√≥n de entrada */
@keyframes slideIn {
    from { transform: translateX(-100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.chats-panel {
    animation: slideIn 0.3s ease-out;
}

/* CORRECCI√ìN ADICIONAL: Estilos de respaldo para casos extremos */
.avatar[class*="trabajador"],
.user-type[class*="trabajador"] {
    background: linear-gradient(135deg, #48bb78, #38a169) !important;
}

.avatar.trabajador,
.avatar.Trabajador,
.avatar.TRABAJADOR,
.user-type.trabajador,
.user-type.Trabajador,
.user-type.TRABAJADOR {
    background: linear-gradient(135deg, #48bb78, #38a169);
}
</style>
</head>
<body>
    <div class="whatsapp-container">
        <!-- Panel izquierdo - Lista de chats -->
        <div class="chats-panel" id="chatsPanel">
            <!-- Barra superior -->
            <div class="chats-header">

                <!-- AGREGAR ESTO DENTRO DEL <div class="chats-header"> -->
<a href="/home" class="home-btn" title="Volver al Home">
    <i class="fas fa-home"></i>
</a>
                <div class="user-avatar" title="Mi perfil">
                    {{ session.get('user_name', 'U')[0] }}
                </div>
                <div class="chats-actions">
                    <button class="chat-action-btn" title="Nuevo chat">
                        <i class="fas fa-comment-medical"></i>
                    </button>
                    <button class="chat-action-btn" title="Men√∫">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <!-- Barra de b√∫squeda -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar conversaciones..." class="search-input" id="searchInput">
                </div>
            </div>

            <!-- Lista de chats -->
            <div class="chats-list" id="chatsList">
                {% if conversaciones and conversaciones|length > 0 %}
                    {% for conversacion in conversaciones %}
                    <div class="chat-item {% if conversacion.id == conversacion_activa %}active{% endif %}" 
                         data-conversacion-id="{{ conversacion.id }}"
                         onclick="abrirChat('{{ conversacion.id }}')">
                        <div class="chat-avatar avatar {{ conversacion.otro_usuario_tipo or 'usuario' }}">
                            {{ conversacion.otro_usuario_nombre[0] if conversacion.otro_usuario_nombre else 'U' }}
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <h3 class="chat-name">{{ conversacion.otro_usuario_nombre or 'Usuario' }}</h3>
                                <span class="chat-time">
                                    {% if conversacion.ultimo_timestamp %}
                                        {{ conversacion.ultimo_timestamp.strftime('%H:%M') }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="chat-preview">
                                <p class="chat-message">
                                    {{ conversacion.ultimo_mensaje or 'Haz click para iniciar chat' }}
                                </p>
                                {% if conversacion.no_leidos > 0 %}
                                <span class="chat-badge">
                                    {{ conversacion.no_leidos if conversacion.no_leidos < 10 else '9+' }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="chats-empty">
                        <i class="fas fa-comments"></i>
                        <h3>No hay conversaciones</h3>
                        <p>Inicia un nuevo chat para comenzar</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Panel derecho - Chat activo o pantalla de bienvenida -->
        <div class="chat-panel" id="chatPanel">
            {% if conversacion_activa and mensajes is defined %}
                <!-- Chat activo -->
                <div class="chat-header-active">
                    <div class="back-btn" onclick="volverALista()">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="contact-info">
                        <div class="chat-avatar avatar {{ otro_usuario_tipo }}">
                            {{ otro_usuario_nombre[0] if otro_usuario_nombre else 'U' }}
                        </div>
                        <div class="contact-details">
                            <h2>{{ otro_usuario_nombre or 'Usuario' }}</h2>
                            <span class="user-type {{ otro_usuario_tipo }}">
                                {{ otro_usuario_tipo }}
                            </span>
                            {% if otro_usuario_email %}
                            <div class="user-email">{{ otro_usuario_email }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- √Årea de mensajes -->
                <div class="messages-container" id="messagesContainer">
                    {% if mensajes %}
                        {% for mensaje in mensajes %}
                            <div class="message {% if mensaje.emisor_id == user_id %}sent{% else %}received{% endif %}">
                                <div class="message-content">
                                    <p>{{ mensaje.contenido }}</p>
                                    <span class="message-time">
                                        {{ mensaje.timestamp_str }}
                                        {% if mensaje.emisor_id == user_id %}
                                            <span class="message-status {% if mensaje.leido %}read{% else %}delivered{% endif %}">
                                                <i class="fas fa-{% if mensaje.leido %}check-double{% else %}check{% endif %}"></i>
                                            </span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- Conversaci√≥n vac√≠a -->
                        <div class="chats-empty">
                            <i class="fas fa-comments"></i>
                            <h3>Conversaci√≥n vac√≠a</h3>
                            <p>Env√≠a el primer mensaje para comenzar</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Input de mensaje -->
                <div class="message-input-container">
                    <form id="messageForm">
                        <input type="hidden" id="conversacionId" value="{{ conversacion_activa }}">
                        <input type="hidden" id="userId" value="{{ user_id }}">
                        <div class="input-group">
                            <textarea 
                                id="messageInput" 
                                placeholder="Escribe tu mensaje..." 
                                maxlength="1000"
                                autocomplete="off"
                                rows="1"
                            ></textarea>
                            <button type="submit" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            {% else %}
                <!-- Pantalla de bienvenida -->
                <div class="no-chat-selected">
                    <i class="fas fa-comments"></i>
                    <h1>Quick Fix Chat</h1>
                    <p>Selecciona una conversaci√≥n para comenzar a chatear o inicia una nueva conversaci√≥n.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // =============================================
        // VARIABLES GLOBALES
        // =============================================
        let currentConversationId = null;
        let autoReloadInterval = null;

        // =============================================
        // FUNCIONES DE NAVEGACI√ìN
        // =============================================

        function abrirChat(conversacionId) {
            currentConversationId = conversacionId;
            
            // Actualizar URL sin recargar la p√°gina
            const newUrl = `/chat_home?conversacion=${conversacionId}`;
            window.history.pushState({ conversacionId }, '', newUrl);
            
            // Cargar el chat via AJAX
            cargarChat(conversacionId);
            
            // En m√≥vil, ocultar lista de chats
            if (window.innerWidth <= 768) {
                document.getElementById('chatsPanel').classList.add('hidden');
            }
        }

        function volverALista() {
            // En m√≥vil, mostrar lista de chats
            if (window.innerWidth <= 768) {
                document.getElementById('chatsPanel').classList.remove('hidden');
            }
            
            // Limpiar intervalo de auto-reload
            if (autoReloadInterval) {
                clearInterval(autoReloadInterval);
                autoReloadInterval = null;
            }
            
            // Limpiar URL
            window.history.pushState({}, '', '/chat_home');
            
            // Recargar la p√°gina para volver al estado inicial
            window.location.reload();
        }

        // =============================================
        // CARGA DE CHAT VIA AJAX
        // =============================================

        async function cargarChat(conversacionId) {
            try {
                const response = await fetch(`/chat_home?conversacion=${conversacionId}&ajax=1`);
                const html = await response.text();
                
                // Reemplazar el contenido del panel de chat
                document.getElementById('chatPanel').innerHTML = html;
                
                // Inicializar funcionalidades del chat
                inicializarChat();
                
                // Iniciar auto-reload para este chat
                iniciarAutoReload();
                
            } catch (error) {
                console.error('Error cargando chat:', error);
            }
        }

        function inicializarChat() {
            // Re-inicializar event listeners del chat
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (messageForm) {
                messageForm.addEventListener('submit', manejarEnvioMensaje);
                messageInput.addEventListener('input', autoResizeTextarea);
                
                // Tecla Enter para enviar
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        messageForm.dispatchEvent(new Event('submit'));
                    }
                });
                
                // Enfocar el input
                messageInput.focus();
            }
            
            // Scroll al final de los mensajes
            scrollToBottom();
            
            // Marcar mensajes como le√≠dos
            marcarMensajesComoLeidos();
        }

        // =============================================
        // FUNCIONALIDADES DEL CHAT
        // =============================================

        async function manejarEnvioMensaje(e) {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const contenido = messageInput.value.trim();
            
            if (!contenido) return;

            // Deshabilitar temporalmente
            sendButton.disabled = true;
            messageInput.disabled = true;

            await enviarMensaje(contenido);
            
            // Limpiar y re-habilitar
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        // Auto-ajustar altura del textarea
        function autoResizeTextarea() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            }
        }

        // Scroll al final de los mensajes
        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // =============================================
        // FUNCIONES DE MENSAJES (igual que antes)
        // =============================================

        async function enviarMensaje(contenido) {
            if (!contenido.trim()) return null;

            const messagesContainer = document.getElementById('messagesContainer');
            const conversacionId = document.getElementById('conversacionId').value;
            const userId = document.getElementById('userId').value;

            // Crear mensaje optimista
            const newMessage = createMessageElement(contenido, true, 'Enviando...');
            messagesContainer.appendChild(newMessage);
            scrollToBottom();

            try {
                const response = await fetch('/api/enviar_mensaje', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        conversacion_id: conversacionId, 
                        contenido: contenido.trim()
                    })
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const result = await response.json();
                
                if (result.success) {
                    const time = result.timestamp || getCurrentTime();
                    newMessage.querySelector('.message-time').innerHTML = 
                        `${time} 
                         <span class="message-status delivered">
                             <i class="fas fa-check"></i>
                         </span>`;
                    return newMessage;
                } else {
                    showErrorMessage(newMessage, result.message || 'Error desconocido');
                    return null;
                }
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                showErrorMessage(newMessage, 'Error de conexi√≥n. Intenta nuevamente.');
                return null;
            }
        }

        async function marcarMensajesComoLeidos() {
            try {
                const conversacionId = document.getElementById('conversacionId').value;
                const response = await fetch('/api/marcar_leidos', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ conversacion_id: conversacionId })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`‚úÖ ${result.mensajes_actualizados} mensajes marcados como le√≠dos`);
                }
            } catch (error) {
                console.error('‚ùå Error marcando mensajes como le√≠dos:', error);
            }
        }

        // =============================================
        // FUNCIONES AUXILIARES
        // =============================================

        function createMessageElement(contenido, isSent = true, timestamp = null) {
            const messageId = 'temp_' + Date.now();
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            messageElement.id = messageId;
            
            const time = timestamp || getCurrentTime();
            const statusHtml = isSent ? 
                `<span class="message-status delivered">
                    <i class="fas fa-check"></i>
                </span>` : '';

            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${contenido}</p>
                    <span class="message-time">
                        ${time} ${statusHtml}
                    </span>
                </div>
            `;

            return messageElement;
        }

        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function showErrorMessage(messageElement, error) {
            messageElement.querySelector('.message-content').innerHTML = `
                <p style="color: #e53e3e; font-style: italic;">
                    ‚ùå ${error}
                </p>
            `;
        }

        // =============================================
        // AUTO-RELOAD
        // =============================================

        function iniciarAutoReload() {
            // Limpiar intervalo anterior
            if (autoReloadInterval) {
                clearInterval(autoReloadInterval);
            }
            
            // Configurar nuevo intervalo
            autoReloadInterval = setInterval(() => {
                if (currentConversationId) {
                    recargarChatActual();
                }
            }, 5000); // Recargar cada 5 segundos
        }

        async function recargarChatActual() {
            if (!currentConversationId) return;
            
            try {
                const response = await fetch(`/chat_home?conversacion=${currentConversationId}&ajax=1`);
                const html = await response.text();
                
                // Extraer solo los mensajes del HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newMessagesContainer = tempDiv.querySelector('#messagesContainer');
                
                if (newMessagesContainer) {
                    const currentContainer = document.getElementById('messagesContainer');
                    currentContainer.innerHTML = newMessagesContainer.innerHTML;
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error recargando chat:', error);
            }
        }

        // =============================================
        // B√öSQUEDA
        // =============================================

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-name').textContent.toLowerCase();
                if (chatName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // =============================================
        // MANEJO DEL HISTORIAL DEL NAVEGADOR
        // =============================================

        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.conversacionId) {
                abrirChat(event.state.conversacionId);
            } else {
                volverALista();
            }
        });

        // =============================================
        // INICIALIZACI√ìN
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Chat inicializado');
            
            // Verificar si hay un chat en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const conversacionId = urlParams.get('conversacion');
            
            if (conversacionId) {
                abrirChat(conversacionId);
            }
        });

    </script>
</body>
</html>